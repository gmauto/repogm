----kpi_2(进站频次_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 
----kpi_2(进站频次_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;

----kpi_2(进站频次_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;

----kpi_2(进站频次_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2(进站频次_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end;

----kpi_2(进站频次_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2(进站频次_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2(进站频次_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2(进站频次_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;
 
 
----kpi_2.1(五年基盘客户数_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 

----kpi_2.1(五年基盘客户数_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;

----kpi_2.1(五年基盘客户数_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;

----kpi_2.1(五年基盘客户数_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.1(五年基盘客户数_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t 
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2.1(五年基盘客户数_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t 
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.1(五年基盘客户数_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2.1(五年基盘客户数_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t 
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.1(五年基盘客户数_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;
 
----kpi_2.2(一年有效基盘_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 

----kpi_2.2(一年有效基盘_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;

----kpi_2.2(一年有效基盘_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;

----kpi_2.2(一年有效基盘_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.2(一年有效基盘_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2.2(一年有效基盘_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.2(一年有效基盘_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2.2(一年有效基盘_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.2(一年有效基盘_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;
 



----kpi_2.3(年进站保养频次_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 

----kpi_2.3(年进站保养频次_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;

----kpi_2.3(年进站保养频次_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;

----kpi_2.3(年进站保养频次_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.3(年进站保养频次_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2.3(年进站保养频次_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.3(年进站保养频次_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2.3(年进站保养频次_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.3(年进站保养频次_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;
 
 

----kpi_2.4(五年新车销售数_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 

----kpi_2.4(五年新车销售数_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;

----kpi_2.4(五年新车销售数_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;

----kpi_2.4(五年新车销售数_车龄)
insert overwrite table kpi_agetype_8areas
select case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.4(五年新车销售数_保内外)
insert overwrite table kpi_bnbw_8areas
select case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end ;

----kpi_2.4(五年新车销售数_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.4(五年新车销售数_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end ;

----kpi_2.4(五年新车销售数_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,
 second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end ;
 
 
----kpi_2.4(五年新车销售数_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,
 second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>'' 
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end ; 



----kpi_2.41(五年年均新车销售数_total)
insert overwrite table kpi_total_8areas
select mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_total_8areas s ,
(
select min(mon) as minmon,asc_code from kpi_total_8areas
where kpi='kpi_2_4'
group by asc_code
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_一级)
insert overwrite table kpi_a_level_8areas
select a_level,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_a_level_8areas s ,
(
select min(mon) as minmon,asc_code,a_level from kpi_a_level_8areas
where kpi='kpi_2_4'
group by asc_code,a_level
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_二级)
insert overwrite table kpi_b_level_8areas
select a_level,
b_level,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.b_level,s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_b_level_8areas s ,
(
select min(mon) as minmon,asc_code,a_level,b_level from kpi_b_level_8areas
where kpi='kpi_2_4'
group by asc_code,a_level,b_level
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.b_level=t.b_level
and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_车龄)
insert overwrite table kpi_agetype_8areas
select age_type,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.age_type,s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_agetype_8areas s ,
(
select min(mon) as minmon,asc_code,age_type from kpi_agetype_8areas
where kpi='kpi_2_4'
group by asc_code,age_type
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.age_type=t.age_type
and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_保内外)
insert overwrite table kpi_bnbw_8areas
select bnbw,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.bnbw,s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_bnbw_8areas s ,
(
select min(mon) as minmon,asc_code,bnbw from kpi_bnbw_8areas
where kpi='kpi_2_4'
group by asc_code,bnbw
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.bnbw=t.bnbw
and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select a_level,
age_type,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.age_type,s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_a_agetype_8areas s ,
(
select min(mon) as minmon,asc_code,a_level,age_type from kpi_a_agetype_8areas
where kpi='kpi_2_4'
group by asc_code,a_level,age_type
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.age_type=t.age_type
and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
) s ;


----kpi_2.41(五年年均新车销售数_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select a_level,
bnbw,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.bnbw,s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_a_bnbw_8areas s ,
(
select min(mon) as minmon,asc_code,a_level,bnbw from kpi_a_bnbw_8areas
where kpi='kpi_2_4'
group by asc_code,a_level,bnbw
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.bnbw=t.bnbw
and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select a_level,
b_level,
age_type,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.b_level,s.age_type,s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_b_agetype_8areas s ,
(
select min(mon) as minmon,asc_code,a_level,b_level,age_type from kpi_b_agetype_8areas
where kpi='kpi_2_4'
group by asc_code,a_level,age_type,b_level
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.age_type=t.age_type
and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
and s.b_level=t.b_level
) s ;

----kpi_2.41(五年年均新车销售数_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select a_level,
b_level,
bnbw,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.b_level,s.bnbw,s.mon,
mon_diff(concat(s.mon,'-01'),concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_b_bnbw_8areas s ,
(
select min(mon) as minmon,asc_code,a_level,b_level,bnbw from kpi_b_bnbw_8areas
where kpi='kpi_2_4'
group by asc_code,a_level,bnbw,b_level
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.bnbw=t.bnbw
and s.b_level=t.b_level
and s.mon>='${begin_date}'
 and s.mon<='${end_date}'
) s ;

----kpi_2.42(本年新车销售数_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 

----kpi_2.42(本年新车销售数_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;

----kpi_2.42(本年新车销售数_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;

----kpi_2.42(本年新车销售数_车龄)
insert overwrite table kpi_agetype_8areas
select case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.42(本年新车销售数_保内外)
insert overwrite table kpi_bnbw_8areas
select case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end ;

----kpi_2.42(本年新车销售数_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.42(本年新车销售数_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end ;

----kpi_2.42(本年新车销售数_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,
 second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.42(本年新车销售数_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,
 second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_doss s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
 on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.primary_classification<>'' and s.asc_code<>''
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
 when tran_date(s.invoice_date)<'2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
 when tran_date(s.invoice_date)>='2013-10-01' 
 and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
 else '' end ;

----kpi_3(客户忠诚率_total)
insert overwrite table kpi_total_8areas
 select s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.mon,count(*) as cnt from ( 
 select am.group_name,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,
 s.vin,
 substr(t.mon_label,1,7)
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon
 ) s ,
 (select * from kpi_total_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon;

----kpi_3(客户忠诚率_一级)
insert overwrite table kpi_a_level_8areas
select s.primary_classification,
 s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.primary_classification,s.mon,count(*) as cnt from 
 ( 
 select am.group_name,
 s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,
 s.vin,
 substr(t.mon_label,1,7),
 s.primary_classification
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon,primary_classification
 ) s ,
 (select * from kpi_a_level_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon and s.primary_classification=t.a_level;

----kpi_3(客户忠诚率_二级)
insert overwrite table kpi_b_level_8areas
select s.primary_classification,
 s.second_level_classification,
 s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.primary_classification,s.second_level_classification,s.mon,count(*) as cnt from 
 ( 
 select am.group_name,
 s.primary_classification,
 s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,
 s.vin,
 substr(t.mon_label,1,7),
 s.primary_classification,
 s.second_level_classification
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon,primary_classification,s.second_level_classification
 ) s ,
 (select * from kpi_b_level_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon and s.primary_classification=t.a_level
 and s.second_level_classification=t.b_level
 ;

----kpi_3(客户忠诚率_车龄)
insert overwrite table kpi_agetype_8areas
select s.agetype,
 s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.agetype,s.mon,count(*) as cnt from 
 ( 
 select am.group_name,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,
 s.vin,
 substr(t.mon_label,1,7),
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon,agetype
 ) s ,
 (select * from kpi_agetype_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon and s.agetype=t.age_type;

----kpi_3(客户忠诚率_保内外)
insert overwrite table kpi_bnbw_8areas
select s.bn,
 s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.bn,s.mon,count(*) as cnt from 
 ( 
 select am.group_name,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,
 s.vin,
 substr(t.mon_label,1,7),
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end 
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon,bn
 ) s ,
 (select * from kpi_bnbw_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon and s.bn=t.bnbw;

----kpi_3(客户忠诚率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select s.primary_classification,s.agetype,
 s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.primary_classification,s.agetype,s.mon,count(*) as cnt from 
 ( 
 select am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,primary_classification,
 s.vin,
 substr(t.mon_label,1,7),
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon,agetype,primary_classification
 ) s ,
 (select * from kpi_a_agetype_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon and s.agetype=t.age_type and s.primary_classification=t.a_level;

----kpi_3(客户忠诚率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select s.primary_classification,s.bn,
 s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.primary_classification,s.bn,s.mon,count(*) as cnt from 
 ( 
 select am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,primary_classification,
 s.vin,
 substr(t.mon_label,1,7),
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon,bn,primary_classification
 ) s ,
 (select * from kpi_a_bnbw_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon and s.bn=t.bnbw and s.primary_classification=t.a_level;

----kpi_3(客户忠诚率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select s.primary_classification,s.second_level_classification,s.agetype,
 s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.primary_classification,s.second_level_classification,
 s.agetype,s.mon,count(*) as cnt from 
 ( 
 select am.group_name,primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7),
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon,agetype,primary_classification,s.second_level_classification
 ) s ,
 (select * from kpi_b_agetype_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon and s.agetype=t.age_type and s.primary_classification=t.a_level
 and s.second_level_classification=t.b_level
 ;

----kpi_3(客户忠诚率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select s.primary_classification,s.second_level_classification,s.bn,
 s.mon,
 s.cnt/t.num as num,
 s.group_name
 from (
 select s.group_name,s.primary_classification,s.second_level_classification,
 s.bn,s.mon,count(*) as cnt from 
 ( 
 select am.group_name,primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,
 count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end) 
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 join ${pub_db}.asc_mapping am 
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by am.group_name,primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7),
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end 
 having count(distinct case when s.MAINT_TYPE1='保养' and s.order_balance_amount>0 then tran_date(s.order_balance_date) else null end)>=2
 ) s group by s.group_name,s.mon,bn,primary_classification,s.second_level_classification
 ) s ,
 (select * from kpi_b_bnbw_8areas where kpi='kpi_2_2') t
 where s.group_name=t.asc_code and s.mon=t.mon and s.bn=t.bnbw and s.primary_classification=t.a_level
 and s.second_level_classification=t.b_level
 ;

----kpi_3.1(首保进站率_total)
insert overwrite table kpi_total_8areas
 select s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon
 group by s.mon,s.group_name;

----kpi_3.1(首保进站率_一级)
insert overwrite table kpi_a_level_8areas
 select s.primary_classification,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name 
 from (
 select am.group_name,s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.primary_classification;

----kpi_3.1(首保进站率_二级)
insert overwrite table kpi_b_level_8areas
select s.primary_classification,s.second_level_classification,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.primary_classification,s.second_level_classification;

----kpi_3.1(首保进站率_车龄)
insert overwrite table kpi_agetype_8areas
select s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type
 group by s.mon,s.group_name,s.age_type;

----kpi_3.1(首保进站率_保内外)
insert overwrite table kpi_bnbw_8areas
select s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn
 group by s.mon,s.group_name,s.bn;

----kpi_3.1(首保进站率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select s.primary_classification,s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
	s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,
 s.primary_classification
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.age_type,s.primary_classification;

----kpi_3.1(首保进站率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select s.primary_classification,s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select s.primary_classification,
 am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct s.primary_classification,
 am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.bn,s.primary_classification;

----kpi_3.1(首保进站率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
	s.primary_classification,
	s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,
 s.primary_classification,
 s.second_level_classification
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.age_type,s.primary_classification,s.second_level_classification;

----kpi_3.1(首保进站率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select s.primary_classification,s.second_level_classification,
 am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct s.primary_classification,s.second_level_classification,
 am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.bn,s.primary_classification,s.second_level_classification;
 
 
 

 
----kpi_3.12(本店销售车辆首保回站率_total)
insert overwrite table kpi_total_8areas
 select s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon
 group by s.mon,s.group_name;

----kpi_3.12(本店销售车辆首保回站率_一级)
insert overwrite table kpi_a_level_8areas
 select s.primary_classification,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.primary_classification;

----kpi_3.12(本店销售车辆首保回站率_二级)
insert overwrite table kpi_b_level_8areas
select s.primary_classification,s.second_level_classification,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.primary_classification,s.second_level_classification;

----kpi_3.12(本店销售车辆首保回站率_车龄)
insert overwrite table kpi_agetype_8areas
select s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type
 group by s.mon,s.group_name,s.age_type;

----kpi_3.12(本店销售车辆首保回站率_保内外)
insert overwrite table kpi_bnbw_8areas
select s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn
 group by s.mon,s.group_name,s.bn;

----kpi_3.12(本店销售车辆首保回站率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select s.primary_classification,s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
	s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,
 s.primary_classification
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.age_type,s.primary_classification;

----kpi_3.12(本店销售车辆首保回站率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select s.primary_classification,s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select s.primary_classification,
 am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct s.primary_classification,
 am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.bn,s.primary_classification;

----kpi_3.12(本店销售车辆首保回站率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
	s.primary_classification,
	s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,
 s.primary_classification,
 s.second_level_classification
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.age_type,s.primary_classification,s.second_level_classification;

----kpi_3.12(本店销售车辆首保回站率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select s.primary_classification,s.second_level_classification,
 am.group_name,case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_doss s
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 and am.version='8areas'
 ) s left join( 
 select distinct s.primary_classification,s.second_level_classification,
 am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.bn,s.primary_classification,s.second_level_classification;
 
----kpi_3.2(首次付费保养进站率_total)
insert overwrite table kpi_total_8areas
select s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin
 group by s.mon,s.group_name ;
 
 
 

----kpi_3.2(首次付费保养进站率_一级)
insert overwrite table kpi_a_level_8areas
 select s.primary_classification,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin 
 and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.primary_classification;

----kpi_3.2(首次付费保养进站率_二级)
insert overwrite table kpi_b_level_8areas
 select s.primary_classification,s.second_level_classification,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.primary_classification,s.second_level_classification;

----kpi_3.2(首次付费保养进站率_车龄)
insert overwrite table kpi_agetype_8areas
select s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin 
 and s.age_type=t.age_type
 group by s.mon,s.group_name,s.age_type;

----kpi_3.2(首次付费保养进站率_保内外)
insert overwrite table kpi_bnbw_8areas
select s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin 
 and s.bn=t.bn
 group by s.mon,s.group_name,s.bn;

----kpi_3.2(首次付费保养进站率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select s.primary_classification,s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,s.primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,s.primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.age_type,s.primary_classification;

----kpi_3.2(首次付费保养进站率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select s.primary_classification,s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,s.primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,s.primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 group by s.mon,s.group_name,s.bn,s.primary_classification;

----kpi_3.2(首次付费保养进站率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.age_type,s.primary_classification,s.second_level_classification;

----kpi_3.2(首次付费保养进站率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.group_name 
 from (
select distinct am.group_name,s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
 and am.version='8areas'
) s left join (
select distinct am.group_name,s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 group by s.mon,s.group_name,s.bn,s.primary_classification,s.second_level_classification;
 


----kpi_3.6(客户流失率_total)
insert overwrite table kpi_total_8areas
 select s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_total_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_total_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code;
 

----kpi_3.6(客户流失率_一级)
insert overwrite table kpi_a_level_8areas
 select 
 s.a_level,
 s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_a_level_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_a_level_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.a_level=t.a_level;

----kpi_3.6(客户流失率_二级)
insert overwrite table kpi_b_level_8areas
 select 
 s.a_level,
 s.b_level,
 s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_b_level_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_b_level_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.a_level=t.a_level and s.b_level=t.b_level;

----kpi_3.6(客户流失率_车龄)
insert overwrite table kpi_agetype_8areas
 select 
 s.age_type,
 s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_agetype_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_agetype_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.age_type=t.age_type;

----kpi_3.6(客户流失率_保内外)
insert overwrite table kpi_bnbw_8areas
select 
 s.bnbw,
 s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_bnbw_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_bnbw_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.bnbw=t.bnbw;

----kpi_3.6(客户流失率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select
 s.a_level, 
 s.age_type,
 s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_a_agetype_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_a_agetype_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.age_type=t.age_type and s.a_level=t.a_level;

----kpi_3.6(客户流失率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select
 s.a_level, 
 s.bnbw,
 s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_a_bnbw_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_a_bnbw_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.bnbw=t.bnbw and s.a_level=t.a_level;

----kpi_3.6(客户流失率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select
 s.a_level,
 s.b_level,
 s.age_type,
 s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_b_agetype_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_b_agetype_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.age_type=t.age_type and s.a_level=t.a_level and s.b_level=t.b_level;

----kpi_3.6(客户流失率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select
 s.a_level,
 s.b_level,
 s.bnbw,
 s.mon,
 (s.num-t.num)/s.num as num,
 s.asc_code
 from 
 (select * from kpi_b_bnbw_8areas where kpi='kpi_2_1' and mon>='${begin_date}'
 and mon<='${end_date}') s 
 left join 
 (select * from kpi_b_bnbw_8areas where kpi='kpi_2_2' and mon>='${begin_date}'
 and mon<='${end_date}') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.bnbw=t.bnbw and s.a_level=t.a_level and s.b_level=t.b_level;
 
----kpi_3.61(一年客户流失率_total)
insert overwrite table kpi_total_8areas
 select s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin
 group by s.mon,s.group_name;
 
 

----kpi_3.61(一年客户流失率_一级)
insert overwrite table kpi_a_level_8areas
 select s.primary_classification,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,s.primary_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,s.primary_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.primary_classification=t.primary_classification and s.vin=t.vin
 group by s.mon,s.group_name,s.primary_classification;
 
 
----kpi_3.61(一年客户流失率_二级)
insert overwrite table kpi_b_level_8areas
 select s.primary_classification,s.second_level_classification,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,s.primary_classification,second_level_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,s.primary_classification,second_level_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin
 group by s.mon,s.group_name,s.primary_classification,s.second_level_classification;
 
 

----kpi_3.61(一年客户流失率_车龄)
insert overwrite table kpi_agetype_8areas
 select s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.age_type=t.age_type and s.vin=t.vin
 group by s.mon,s.group_name,s.age_type;

----kpi_3.61(一年客户流失率_保内外)
insert overwrite table kpi_bnbw_8areas
select s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.bn=t.bn and s.vin=t.vin
 group by s.mon,s.group_name,s.bn;

----kpi_3.61(一年客户流失率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select s.primary_classification,s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.age_type=t.age_type 
 and s.primary_classification=t.primary_classification and s.vin=t.vin
 group by s.primary_classification,s.age_type,s.mon,s.group_name;

----kpi_3.61(一年客户流失率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select s.primary_classification,s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.bn=t.bn
 and s.primary_classification=t.primary_classification and s.vin=t.vin
 group by s.primary_classification,s.bn,s.mon,s.group_name;

----kpi_3.61(一年客户流失率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.age_type=t.age_type 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin
 group by s.primary_classification,
 s.second_level_classification,s.age_type,s.mon,s.group_name;

----kpi_3.61(一年客户流失率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.bn=t.bn
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin
 group by s.primary_classification,
 s.second_level_classification,s.bn,s.mon,s.group_name;
 

----kpi_3.62(濒临流失客户率_total)
insert overwrite table kpi_total_8areas
 select s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.vin=t.vin
 group by s.mon,s.group_name;
 
 

----kpi_3.62(濒临流失客户率_一级)
insert overwrite table kpi_a_level_8areas
 select s.primary_classification,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,s.primary_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,s.primary_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon 
 and s.primary_classification=t.primary_classification and s.vin=t.vin
 group by s.primary_classification,s.mon,s.group_name;
 
 
----kpi_3.62(濒临流失客户率_二级)
insert overwrite table kpi_b_level_8areas
 select s.primary_classification,s.second_level_classification,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,s.primary_classification,second_level_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,s.primary_classification,second_level_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin
 group by s.primary_classification,s.second_level_classification,s.mon,s.group_name;
 
 

----kpi_3.62(濒临流失客户率_车龄)
insert overwrite table kpi_agetype_8areas
 select s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.age_type=t.age_type and s.vin=t.vin
 group by s.age_type,s.mon,s.group_name;

----kpi_3.62(濒临流失客户率_保内外)
insert overwrite table kpi_bnbw_8areas
select s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.bn=t.bn and s.vin=t.vin
 group by s.bn,s.mon,s.group_name;

----kpi_3.62(濒临流失客户率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select s.primary_classification,s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.age_type=t.age_type 
 and s.primary_classification=t.primary_classification and s.vin=t.vin
 group by s.primary_classification,s.age_type,s.mon,s.group_name;

----kpi_3.62(濒临流失客户率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select s.primary_classification,s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.bn=t.bn
 and s.primary_classification=t.primary_classification and s.vin=t.vin
 group by s.primary_classification,s.bn,s.mon,s.group_name;

----kpi_3.62(濒临流失客户率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.age_type=t.age_type 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin
 group by s.primary_classification,
 s.second_level_classification,s.age_type,s.mon,s.group_name;

----kpi_3.62(濒临流失客户率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
 s.group_name
 from (
 select distinct am.group_name,primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 and am.version='8areas'
 ) s left join 
 (
 select distinct am.group_name,primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 ) t on s.group_name=t.group_name and s.mon=t.mon and s.bn=t.bn
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin
 group by s.primary_classification,s.second_level_classification,s.bn,s.mon,s.group_name; 
 
----kpi_5(单车产值_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 
 

----kpi_5(单车产值_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;
 
 
----kpi_5(单车产值_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;
 
 

----kpi_5(单车产值_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5(单车产值_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5(单车产值_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;



----kpi_5(单车产值_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5(单车产值_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5(单车产值_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.1(单车年保养产值_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 
 

----kpi_5.1(单车年保养产值_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;
 
 
----kpi_5.1(单车年保养产值_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;
 
 

----kpi_5.1(单车年保养产值_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.1(单车年保养产值_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.1(单车年保养产值_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;
 
----kpi_5.1(单车年保养产值_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5.1(单车年保养产值_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.1(单车年保养产值_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

	
----kpi_5.2(单车年维修产值_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 

----kpi_5.2(单车年维修产值_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;
 
 
----kpi_5.2(单车年维修产值_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;
 
 

----kpi_5.2(单车年维修产值_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.2(单车年维修产值_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.2(单车年维修产值_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;



----kpi_5.2(单车年维修产值_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5.2(单车年维修产值_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.2(单车年维修产值_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.3(单车年事故产值_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 
 

----kpi_5.3(单车年事故产值_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;
 
 
----kpi_5.3(单车年事故产值_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;
 
 

----kpi_5.3(单车年事故产值_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.3(单车年事故产值_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.3(单车年事故产值_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;



----kpi_5.3(单车年事故产值_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5.3(单车年事故产值_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.3(单车年事故产值_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
and s.asc_code=am.asc_code
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;



----kpi_5.4(单车年索赔产值_total)
insert overwrite table kpi_total_8areas
select substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name;
 
 

----kpi_5.4(单车年索赔产值_一级)
insert overwrite table kpi_a_level_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification;
 
 
----kpi_5.4(单车年索赔产值_二级)
insert overwrite table kpi_b_level_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;
 
 

----kpi_5.4(单车年索赔产值_车龄)
insert overwrite table kpi_agetype_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.4(单车年索赔产值_保内外)
insert overwrite table kpi_bnbw_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.4(单车年索赔产值_一级_车龄)
insert overwrite table kpi_a_agetype_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;



----kpi_5.4(单车年索赔产值_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5.4(单车年索赔产值_二级_车龄)
insert overwrite table kpi_b_agetype_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.4(单车年索赔产值_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.asc_mapping am
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;
	
	
----kpi_5.11(单车年保养产值_平价机油_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
 


----kpi_5.11(单车年保养产值_平价机油_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 


----kpi_5.11(单车年保养产值_平价机油_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_5.11(单车年保养产值_平价机油_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.11(单车年保养产值_平价机油_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.11(单车年保养产值_平价机油_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.11(单车年保养产值_平价机油_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.11(单车年保养产值_平价机油_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.11(单车年保养产值_平价机油_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

 
----kpi_5.12(单车年保养产值_中端机油_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
 


----kpi_5.12(单车年保养产值_中端机油_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 


----kpi_5.12(单车年保养产值_中端机油_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_5.12(单车年保养产值_中端机油_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.12(单车年保养产值_中端机油_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.12(单车年保养产值_中端机油_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.12(单车年保养产值_中端机油_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.12(单车年保养产值_中端机油_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 
}

----kpi_5.12(单车年保养产值_中端机油_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.13(单车年保养产值_高端机油_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
 


----kpi_5.13(单车年保养产值_高端机油_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 


----kpi_5.13(单车年保养产值_高端机油_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 
}

----kpi_5.13(单车年保养产值_高端机油_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.13(单车年保养产值_高端机油_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.13(单车年保养产值_高端机油_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.13(单车年保养产值_高端机油_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.13(单车年保养产值_高端机油_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.13(单车年保养产值_高端机油_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m1
 on t.part_number=p.part_num
 and p.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_3.4(养护品着装率_total)
insert overwrite table kpi_total_8areas 
 select 
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name;
 
----kpi_3.4(养护品着装率_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification;

----kpi_3.4(养护品着装率_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification,second_level_classification;

----kpi_3.4(养护品着装率_车龄)
insert overwrite table kpi_agetype_8areas 
 select age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type;

----kpi_3.4(养护品着装率_保内外)
insert overwrite table kpi_bnbw_8areas 
 select bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn;

----kpi_3.4(养护品着装率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification;


----kpi_3.4(养护品着装率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification;


----kpi_3.4(养护品着装率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification,second_level_classification;


----kpi_3.4(养护品着装率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification,second_level_classification;



----kpi_5.5(单车年养护品工单产值_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 


----kpi_5.5(单车年养护品工单产值_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
 from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 




----kpi_5.5(单车年养护品工单产值_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 


----kpi_5.5(单车年养护品工单产值_车龄)
insert overwrite table kpi_agetype_8areas 
select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.5(单车年养护品工单产值_保内外)
insert overwrite table kpi_bnbw_8areas 
select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.5(单车年养护品工单产值_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
group by substr(t.mon_label,1,7),am.group_name,primary_classification,
case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ;


----kpi_5.5(单车年养护品工单产值_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.5(单车年养护品工单产值_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ;


----kpi_5.5(单车年养护品工单产值_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.order_number=m.order_number
 and s.asc_code=am.asc_code
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.51(养护品产值_润滑养护_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
}

----kpi_5.51(养护品产值_润滑养护_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 

----kpi_5.51(养护品产值_润滑养护_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification;


----kpi_5.51(养护品产值_润滑养护_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.51(养护品产值_润滑养护_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.51(养护品产值_润滑养护_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
}

----kpi_5.51(养护品产值_润滑养护_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ;

----kpi_5.51(养护品产值_润滑养护_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
}

----kpi_5.51(养护品产值_润滑养护_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='润滑养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
}

----kpi_5.52(养护品产值_燃油养护_total)
 insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
}

----kpi_5.52(养护品产值_燃油养护_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 

----kpi_5.52(养护品产值_燃油养护_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 


----kpi_5.52(养护品产值_燃油养护_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.52(养护品产值_燃油养护_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
}

----kpi_5.52(养护品产值_燃油养护_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.52(养护品产值_燃油养护_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.52(养护品产值_燃油养护_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.52(养护品产值_燃油养护_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='燃油养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.53(养护品产值_节气门养护_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 


----kpi_5.53(养护品产值_节气门养护_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 

----kpi_5.53(养护品产值_节气门养护_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 


----kpi_5.53(养护品产值_节气门养护_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.53(养护品产值_节气门养护_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
}

----kpi_5.53(养护品产值_节气门养护_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.53(养护品产值_节气门养护_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.53(养护品产值_节气门养护_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.53(养护品产值_节气门养护_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='节气门养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.54(养护品产值_空调养护_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 


----kpi_5.54(养护品产值_空调养护_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 


----kpi_5.54(养护品产值_空调养护_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 


----kpi_5.54(养护品产值_空调养护_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.54(养护品产值_空调养护_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.54(养护品产值_空调养护_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.54(养护品产值_空调养护_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.54(养护品产值_空调养护_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.54(养护品产值_空调养护_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
 join ${pub_db}.date_label t
 join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t1.part_number=x.part_num 
 and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
 where x.type='空调养护') m
 join ${pub_db}.asc_mapping am
 on s.asc_code=m.asc_code
 and s.asc_code=am.asc_code 
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_3.5(高流失件渗透率_total)
insert overwrite table kpi_total_8areas 
 select 
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name; 


----kpi_3.5(高流失件渗透率_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='2016-11'
 and substr(tran_date(s.order_balance_date),1,7)<='2016-11'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification; 


----kpi_3.5(高流失件渗透率_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='2016-11'
 and substr(tran_date(s.order_balance_date),1,7)<='2016-11'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification,second_level_classification; 


----kpi_3.5(高流失件渗透率_车龄)
insert overwrite table kpi_agetype_8areas 
 select age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='2016-11'
 and substr(tran_date(s.order_balance_date),1,7)<='2016-11'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type; 


----kpi_3.5(高流失件渗透率_保内外)
insert overwrite table kpi_bnbw_8areas 
 select bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='2016-11'
 and substr(tran_date(s.order_balance_date),1,7)<='2016-11'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn; 


----kpi_3.5(高流失件渗透率_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='2016-11'
 and substr(tran_date(s.order_balance_date),1,7)<='2016-11'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification; 


----kpi_3.5(高流失件渗透率_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='2016-11'
 and substr(tran_date(s.order_balance_date),1,7)<='2016-11'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification; 


----kpi_3.5(高流失件渗透率_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='2016-11'
 and substr(tran_date(s.order_balance_date),1,7)<='2016-11'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification,second_level_classification; 


----kpi_3.5(高流失件渗透率_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='2016-11'
 and substr(tran_date(s.order_balance_date),1,7)<='2016-11'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification,second_level_classification; 

----kpi_3.51(轮胎_total)
insert overwrite table kpi_total_8areas 
 select 
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name; 


----kpi_3.51(轮胎_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification; 


----kpi_3.51(轮胎_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification,second_level_classification; 


----kpi_3.51(轮胎_车龄)
insert overwrite table kpi_agetype_8areas 
 select age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type; 


----kpi_3.51(轮胎_保内外)
insert overwrite table kpi_bnbw_8areas 
 select bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn; 


----kpi_3.51(轮胎_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification; 


----kpi_3.51(轮胎_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification; 




----kpi_3.51(轮胎_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification,second_level_classification; 
 


----kpi_3.51(轮胎_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='LunT'
 ) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification,second_level_classification; 



----kpi_3.52(蓄电池_total)
insert overwrite table kpi_total_8areas 
 select 
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name; 
 


----kpi_3.52(蓄电池_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification; 
 


----kpi_3.52(蓄电池_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_3.52(蓄电池_车龄)
insert overwrite table kpi_agetype_8areas 
 select age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type; 
 


----kpi_3.52(蓄电池_保内外)
insert overwrite table kpi_bnbw_8areas 
 select bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn; 
 


----kpi_3.52(蓄电池_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification; 
 


----kpi_3.52(蓄电池_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification; 
 


----kpi_3.52(蓄电池_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification,second_level_classification; 
 


----kpi_3.52(蓄电池_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='DianC') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification,second_level_classification; 
 


----kpi_3.53(轮胎+蓄电池_total)
insert overwrite table kpi_total_8areas 
 select 
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name; 
 

----kpi_3.53(轮胎+蓄电池_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification; 
 


----kpi_3.53(轮胎+蓄电池_二级)
 insert overwrite table kpi_b_level_8areas 
 select primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_3.53(轮胎+蓄电池_车龄)
insert overwrite table kpi_agetype_8areas 
 select age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type; 
 


----kpi_3.53(轮胎+蓄电池_保内外)
insert overwrite table kpi_bnbw_8areas 
 select bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn; 
 


----kpi_3.53(轮胎+蓄电池_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification; 
 


----kpi_3.53(轮胎+蓄电池_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification; 
 
}

----kpi_3.53(轮胎+蓄电池_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification,second_level_classification; 
 


----kpi_3.53(轮胎+蓄电池_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
 from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type in('DianC','LunT')) t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification,second_level_classification; 
 


----kpi_3.54(其他高流失件_total)
insert overwrite table kpi_total_8areas 
 select 
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name; 
 


----kpi_3.54(其他高流失件_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification; 
 


----kpi_3.54(其他高流失件_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_3.54(其他高流失件_车龄)
insert overwrite table kpi_agetype_8areas 
 select age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type; 
 


----kpi_3.54(其他高流失件_保内外)
insert overwrite table kpi_bnbw_8areas 
 select bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn; 
 

----kpi_3.54(其他高流失件_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification; 
 


----kpi_3.54(其他高流失件_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification; 
 


----kpi_3.54(其他高流失件_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,age_type,primary_classification,second_level_classification; 
 


----kpi_3.54(其他高流失件_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 am.group_name
from
 (select s.*,t.asc_code  as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
 on t1.part_number=x.part_num and x.version=m1.version
 and substr(tran_date(t1.order_balance_date),1,7)=m1.month
 where x.type='QiT') t 
 on s.order_number=t.order_number 
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s 
 join ${pub_db}.asc_mapping am
 on s.asc_code=am.asc_code
 where am.version='8areas'
 group by substr(tran_date(s.order_balance_date),1,7),am.group_name,bn,primary_classification,second_level_classification; 

 

----kpi_5.6(单车高流失件工单产值_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
 


----kpi_5.6(单车高流失件工单产值_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 


----kpi_5.6(单车高流失件工单产值_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_5.6(单车高流失件工单产值_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.6(单车高流失件工单产值_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.6(单车高流失件工单产值_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.6(单车高流失件工单产值_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.6(单车高流失件工单产值_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.6(单车高流失件工单产值_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 

----kpi_5.61(单车高流失件产值_轮胎_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name; 
 


----kpi_5.61(单车高流失件产值_轮胎_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 


----kpi_5.61(单车高流失件产值_轮胎_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_5.61(单车高流失件产值_轮胎_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12
and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.61(单车高流失件产值_轮胎_保内外)
insert overwrite table kpi_bnbw_8areas 
select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.61(单车高流失件产值_轮胎_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.61(单车高流失件产值_轮胎_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.61(单车高流失件产值_轮胎_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.61(单车高流失件产值_轮胎_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='LunT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.62(单车高流失件产值_蓄电池_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
 


----kpi_5.62(单车高流失件产值_蓄电池_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 


----kpi_5.62(单车高流失件产值_蓄电池_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_5.62(单车高流失件产值_蓄电池_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.62(单车高流失件产值_蓄电池_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.62(单车高流失件产值_蓄电池_一级_车龄)
 insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.62(单车高流失件产值_蓄电池_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.62(单车高流失件产值_蓄电池_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.62(单车高流失件产值_蓄电池_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='DianC' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version 
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type in('DianC','LunT') ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.64(单车高流失件产值_其他_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name; 
 


----kpi_5.64(单车高流失件产值_其他_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 


----kpi_5.64(单车高流失件产值_其他_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 


----kpi_5.64(单车高流失件产值_其他_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.64(单车高流失件产值_其他_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.64(单车高流失件产值_其他_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.64(单车高流失件产值_其他_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 


----kpi_5.64(单车高流失件产值_其他_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
 


----kpi_5.64(单车高流失件产值_其他_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(s.order_balance_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.date_label t
join ${pub_db}.label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.high_flow_parts x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month 
where x.type='QiT' ) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas'
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
 

 
----kpi_5.7(单车年精品附件产值_total)
insert overwrite table kpi_total_8areas 
 select substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name; 


----kpi_5.7(单车年精品附件产值_一级)
insert overwrite table kpi_a_level_8areas 
 select primary_classification,
 substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification; 
 
 

----kpi_5.7(单车年精品附件产值_二级)
insert overwrite table kpi_b_level_8areas 
 select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,second_level_classification; 
 
 
----kpi_5.7(单车年精品附件产值_车龄)
insert overwrite table kpi_agetype_8areas 
 select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.7(单车年精品附件产值_保内外)
insert overwrite table kpi_bnbw_8areas 
 select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.7(单车年精品附件产值_一级_车龄)
insert overwrite table kpi_a_agetype_8areas 
 select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.7(单车年精品附件产值_一级_保内外)
insert overwrite table kpi_a_bnbw_8areas 
 select primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.7(单车年精品附件产值_二级_车龄)
insert overwrite table kpi_b_agetype_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.7(单车年精品附件产值_二级_保内外)
insert overwrite table kpi_b_bnbw_8areas 
 select primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 sum(m.sales_amount)/count(distinct s.vin) as num,
 am.group_name
from ${pub_db}.label_order s
join ${pub_db}.date_label t
join (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from ${pub_db}.part t1 join ${pub_db}.enclosure x
join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version
and substr(tran_date(t1.order_balance_date),1,7)=m1.month
) m
join ${pub_db}.asc_mapping am
on s.asc_code=m.asc_code
and s.asc_code=am.asc_code
 and s.order_number=m.order_number
 and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1<>'删除' and am.version='8areas' 
 group by substr(t.mon_label,1,7),am.group_name,primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 










 
 