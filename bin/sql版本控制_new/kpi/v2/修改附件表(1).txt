----kpi_1.11(平价机油台次_total)
insert overwrite table  kpi_total_test 
  select 
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  


----kpi_1.11(平价机油台次_一级)
insert overwrite table  kpi_a_level_test 
  select 
  s.primary_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
  


----kpi_1.11(平价机油台次_二级)
insert overwrite table  kpi_b_level_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification; 
  


----kpi_1.11(平价机油台次_车龄)
insert overwrite table  kpi_agetype_test
select 
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
  


----kpi_1.11(平价机油台次_保内外)
insert overwrite table  kpi_bnbw_test 
  select 
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
  


----kpi_1.11(平价机油台次_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select 
  s.primary_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.age_type; 
  


----kpi_1.11(平价机油台次_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select 
  s.primary_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.bn; 
  


----kpi_1.11(平价机油台次_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.age_type; 
  


----kpi_1.11(平价机油台次_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
   from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.bn; 
  


----kpi_1.12(中端机油台次_total)
insert overwrite table  kpi_total_test 
  select 
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  


----kpi_1.12(中端机油台次_一级)
insert overwrite table  kpi_a_level_test 
  select 
  s.primary_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
  


----kpi_1.12(中端机油台次_二级)
insert overwrite table  kpi_b_level_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification; 
  


----kpi_1.12(中端机油台次_车龄)
insert overwrite table  kpi_agetype_test 
  select 
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
  


----kpi_1.12(中端机油台次_保内外)
insert overwrite table  kpi_bnbw_test 
  select 
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
  


----kpi_1.12(中端机油台次_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select 
  s.primary_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.age_type; 
  


----kpi_1.12(中端机油台次_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select 
  s.primary_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.bn; 
  


----kpi_1.12(中端机油台次_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.age_type; 
  


----kpi_1.12(中端机油台次_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.bn; 
  


----kpi_1.13(高端机油台次_total)
 insert overwrite table  kpi_total_test 
  select 
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  


----kpi_1.13(高端机油台次_一级)
insert overwrite table  kpi_a_level_test 
  select 
  s.primary_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
  


----kpi_1.13(高端机油台次_二级)
insert overwrite table  kpi_b_level_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification; 
  


----kpi_1.13(高端机油台次_车龄)
insert overwrite table  kpi_agetype_test 
  select 
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
  


----kpi_1.13(高端机油台次_保内外)
insert overwrite table  kpi_bnbw_test 
  select 
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
  


----kpi_1.13(高端机油台次_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select 
  s.primary_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.age_type; 
  


----kpi_1.13(高端机油台次_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select 
  s.primary_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.bn; 
  


----kpi_1.13(高端机油台次_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.age_type; 
  


----kpi_1.13(高端机油台次_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select 
  s.primary_classification,
  s.second_level_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
  s.asc_code
  from label_order s 
  join (select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version )t
  on s.asc_code=t.asc_code 
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.bn; 
  


----kpi_4.11(平价机油_total)
insert overwrite table  kpi_total_test 
  select substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  


----kpi_4.11(平价机油_一级)
insert overwrite table  kpi_a_level_test 
  select s.primary_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
  


----kpi_4.11(平价机油_二级)
insert overwrite table  kpi_b_level_test 
  select s.primary_classification,
  s.second_level_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
  s.second_level_classification; 
  


----kpi_4.11(平价机油_车龄)
insert overwrite table  kpi_agetype_test 
  select s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
  


----kpi_4.11(平价机油_保内外)
insert overwrite table  kpi_bnbw_test 
  select s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
  


----kpi_4.11(平价机油_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select s.primary_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification; 
  


----kpi_4.11(平价机油_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select s.primary_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification; 
  


----kpi_4.11(平价机油_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select s.primary_classification,
  s.second_level_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
  s.second_level_classification; 
  


----kpi_4.11(平价机油_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select s.primary_classification,
  s.second_level_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
  s.second_level_classification; 
  


----kpi_4.12(中端机油_total)
insert overwrite table  kpi_total_test 
  select substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  


----kpi_4.12(中端机油_一级)
insert overwrite table  kpi_a_level_test 
  select s.primary_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
  


----kpi_4.12(中端机油_二级)
insert overwrite table  kpi_b_level_test 
  select s.primary_classification,
  s.second_level_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
  s.second_level_classification; 
  


----kpi_4.12(中端机油_车龄)
insert overwrite table  kpi_agetype_test 
  select s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
  


----kpi_4.12(中端机油_保内外)
insert overwrite table  kpi_bnbw_test 
  select s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
  


----kpi_4.12(中端机油_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select s.primary_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification; 
  


----kpi_4.12(中端机油_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select s.primary_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification; 
  


----kpi_4.12(中端机油_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select s.primary_classification,
  s.second_level_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
  s.second_level_classification; 
  


----kpi_4.12(中端机油_二级_保内外)
 insert overwrite table  kpi_b_bnbw_test 
  select s.primary_classification,
  s.second_level_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
  s.second_level_classification; 
  


----kpi_4.13(高端机油_total)
insert overwrite table  kpi_total_test 
  select substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  


----kpi_4.13(高端机油_一级)
insert overwrite table  kpi_a_level_test 
  select s.primary_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
  


----kpi_4.13(高端机油_二级)
insert overwrite table  kpi_b_level_test 
  select s.primary_classification,
  s.second_level_classification,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
  s.second_level_classification; 
  


----kpi_4.13(高端机油_车龄)
insert overwrite table  kpi_agetype_test 
  select s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
  


----kpi_4.13(高端机油_保内外)
insert overwrite table  kpi_bnbw_test 
  select s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
  


----kpi_4.13(高端机油_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select s.primary_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification; 
  


----kpi_4.13(高端机油_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select s.primary_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification; 
  


----kpi_4.13(高端机油_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select s.primary_classification,
  s.second_level_classification,
  s.age_type,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
  s.second_level_classification; 
  


----kpi_4.13(高端机油_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select s.primary_classification,
  s.second_level_classification,
  s.bn,
  substr(tran_date(s.order_balance_date),1,7) as mon,
  sum(order_balance_amount)/count(distinct s.vin,tran_date(s.order_balance_date)) as num,
  s.asc_code
  from label_order s join 
  (
  select distinct t1.asc_code,t1.order_number,m.month from part t1
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m
  on t1.part_number=p.part_num
  and p.version=m.version
  ) t
  on s.asc_code=t.asc_code
  and s.order_number=t.order_number
  and substr(tran_date(s.order_balance_date),1,7)=t.month
  where s.MAINT_TYPE1='保养'
  and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(order_balance_date),1,7)<='${end_date}'
  and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
  s.second_level_classification; 
  


----kpi_5.11(单车年保养产值_平价机油_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code; 
  


----kpi_5.11(单车年保养产值_平价机油_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
  


----kpi_5.11(单车年保养产值_平价机油_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_5.11(单车年保养产值_平价机油_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.11(单车年保养产值_平价机油_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.11(单车年保养产值_平价机油_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.11(单车年保养产值_平价机油_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.11(单车年保养产值_平价机油_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.11(单车年保养产值_平价机油_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
 from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='低端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  

----kpi_5.12(单车年保养产值_中端机油_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code; 
  
}

----kpi_5.12(单车年保养产值_中端机油_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
  


----kpi_5.12(单车年保养产值_中端机油_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_5.12(单车年保养产值_中端机油_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.12(单车年保养产值_中端机油_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
 from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.12(单车年保养产值_中端机油_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.12(单车年保养产值_中端机油_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.12(单车年保养产值_中端机油_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
 from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  
}

----kpi_5.12(单车年保养产值_中端机油_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='中端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.13(单车年保养产值_高端机油_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code; 
  


----kpi_5.13(单车年保养产值_高端机油_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
  


----kpi_5.13(单车年保养产值_高端机油_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
  
}

----kpi_5.13(单车年保养产值_高端机油_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.13(单车年保养产值_高端机油_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.13(单车年保养产值_高端机油_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.13(单车年保养产值_高端机油_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.13(单车年保养产值_高端机油_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.13(单车年保养产值_高端机油_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
   join (select distinct t.asc_code,t.order_number,m1.month from part t
  join (select * from engine_oil where  type='高端') p
  join (select month,version from mapping where fact_table='label_order' and dim_table='engine_oil') m1
  on t.part_number=p.part_num
  and p.version=m1.version ) m
    on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
    and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
    where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'
    and s.MAINT_TYPE1='保养'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  
}


----kpi_3.4(养护品着装率_total)
insert overwrite table  kpi_total_test 
   select  
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
    
----kpi_3.4(养护品着装率_一级)
insert overwrite table  kpi_a_level_test 
     select  primary_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification;

----kpi_3.4(养护品着装率_二级)
insert overwrite table  kpi_b_level_test 
     select  primary_classification,second_level_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_3.4(养护品着装率_车龄)
insert overwrite table  kpi_agetype_test 
   select  age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type;

----kpi_3.4(养护品着装率_保内外)
insert overwrite table  kpi_bnbw_test 
  select  bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn;

----kpi_3.4(养护品着装率_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select  primary_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification;


----kpi_3.4(养护品着装率_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select  primary_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification;


----kpi_3.4(养护品着装率_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select  primary_classification,second_level_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification;


----kpi_3.4(养护品着装率_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select  primary_classification,second_level_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version 
     ) t 
    on  s.order_number=t.order_number
    and s.asc_code=t.asc_code
    and substr(tran_date(s.order_balance_date),1,7)=t.month
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification;


----kpi_5.5(单车年养护品工单产值_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version   ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code; 


----kpi_5.5(单车年养护品工单产值_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version   ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 


----kpi_5.5(单车年养护品工单产值_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version   ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 


----kpi_5.5(单车年养护品工单产值_车龄)
insert overwrite table  kpi_agetype_test 
select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version   ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.5(单车年养护品工单产值_保内外)
insert overwrite table  kpi_bnbw_test 
select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount)/count(distinct s.vin) as num,
s.asc_code
from date_label t
join label_order s
join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
on t.part_number=x.part_num 
and x.version=m1.version   ) m
on s.asc_code=m.asc_code
and s.order_number=m.order_number
and substr(tran_date(s.order_balance_date),1,7)=m.month
and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
and substr(t.mon_label,1,7)<='${end_date}'  
and s.MAINT_TYPE1<>'删除'
group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.5(单车年养护品工单产值_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version   ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ;


----kpi_5.5(单车年养护品工单产值_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version   ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.5(单车年养护品工单产值_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version   ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ;


----kpi_5.5(单车年养护品工单产值_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t.asc_code,t.order_number,m1.month from part t join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t.part_number=x.part_num 
    and x.version=m1.version   ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.51(养护品产值_润滑养护_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code; 
}

----kpi_5.51(养护品产值_润滑养护_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 

----kpi_5.51(养护品产值_润滑养护_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification;


----kpi_5.51(养护品产值_润滑养护_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.51(养护品产值_润滑养护_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.51(养护品产值_润滑养护_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
}

----kpi_5.51(养护品产值_润滑养护_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ;

----kpi_5.51(养护品产值_润滑养护_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
}

----kpi_5.51(养护品产值_润滑养护_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
   join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='润滑养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
}

----kpi_5.52(养护品产值_燃油养护_total)
 insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code; 
}

----kpi_5.52(养护品产值_燃油养护_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 

----kpi_5.52(养护品产值_燃油养护_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 


----kpi_5.52(养护品产值_燃油养护_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.52(养护品产值_燃油养护_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
}

----kpi_5.52(养护品产值_燃油养护_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
 from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.52(养护品产值_燃油养护_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.52(养护品产值_燃油养护_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.52(养护品产值_燃油养护_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='燃油养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.53(养护品产值_节气门养护_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
    from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code; 


----kpi_5.53(养护品产值_节气门养护_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 

----kpi_5.53(养护品产值_节气门养护_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 


----kpi_5.53(养护品产值_节气门养护_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.53(养护品产值_节气门养护_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
}

----kpi_5.53(养护品产值_节气门养护_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.53(养护品产值_节气门养护_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.53(养护品产值_节气门养护_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.53(养护品产值_节气门养护_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='节气门养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.54(养护品产值_空调养护_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code; 


----kpi_5.54(养护品产值_空调养护_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 


----kpi_5.54(养护品产值_空调养护_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 


----kpi_5.54(养护品产值_空调养护_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.54(养护品产值_空调养护_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.54(养护品产值_空调养护_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 


----kpi_5.54(养护品产值_空调养护_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01'  and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01'  and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_5.54(养护品产值_空调养护_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.54(养护品产值_空调养护_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
  join label_order s
  join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join maintnance x
    join (select month,version from mapping where fact_table='label_order' and dim_table='maintnance') m1
    on t1.part_number=x.part_num 
    and x.version=m1.version  
   where  x.type='空调养护') m
  on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'  
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


----kpi_3.5(高流失件渗透率_total)
insert overwrite table  kpi_total_test 
   select  
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 


----kpi_3.5(高流失件渗透率_一级)
insert overwrite table  kpi_a_level_test 
     select  primary_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification; 


----kpi_3.5(高流失件渗透率_二级)
insert overwrite table  kpi_b_level_test 
     select  primary_classification,second_level_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification; 


----kpi_3.5(高流失件渗透率_车龄)
insert overwrite table  kpi_agetype_test 
   select  age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type; 


----kpi_3.5(高流失件渗透率_保内外)
insert overwrite table  kpi_bnbw_test 
  select  bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn; 


----kpi_3.5(高流失件渗透率_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select  primary_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification; 


----kpi_3.5(高流失件渗透率_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select  primary_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification; 


----kpi_3.5(高流失件渗透率_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select  primary_classification,second_level_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification; 


----kpi_3.5(高流失件渗透率_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select  primary_classification,second_level_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification; 


----kpi_3.51(轮胎_total)
insert overwrite table  kpi_total_test 
   select  
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 


----kpi_3.51(轮胎_一级)
insert overwrite table  kpi_a_level_test 
     select  primary_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification; 


----kpi_3.51(轮胎_二级)
insert overwrite table  kpi_b_level_test 
     select  primary_classification,second_level_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification; 


----kpi_3.51(轮胎_车龄)
insert overwrite table  kpi_agetype_test 
   select  age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type; 


----kpi_3.51(轮胎_保内外)
insert overwrite table  kpi_bnbw_test 
  select  bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn; 


----kpi_3.51(轮胎_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select  primary_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification; 


----kpi_3.51(轮胎_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select  primary_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification; 




----kpi_3.51(轮胎_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select  primary_classification,second_level_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification; 
  


----kpi_3.51(轮胎_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select  primary_classification,second_level_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='LunT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除' 
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification; 
  


----kpi_3.52(蓄电池_total)
insert overwrite table  kpi_total_test 
   select  
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  


----kpi_3.52(蓄电池_一级)
insert overwrite table  kpi_a_level_test 
     select  primary_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification; 
  


----kpi_3.52(蓄电池_二级)
insert overwrite table  kpi_b_level_test 
     select  primary_classification,second_level_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_3.52(蓄电池_车龄)
insert overwrite table  kpi_agetype_test 
   select  age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type; 
  


----kpi_3.52(蓄电池_保内外)
insert overwrite table  kpi_bnbw_test 
  select  bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn; 
 


----kpi_3.52(蓄电池_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select  primary_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification; 
  


----kpi_3.52(蓄电池_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select  primary_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification; 
  


----kpi_3.52(蓄电池_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select  primary_classification,second_level_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification; 
  


----kpi_3.52(蓄电池_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select  primary_classification,second_level_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='DianC') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification; 
  


----kpi_3.53(轮胎+蓄电池_total)
insert overwrite table  kpi_total_test 
   select  
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  

----kpi_3.53(轮胎+蓄电池_一级)
insert overwrite table  kpi_a_level_test 
     select  primary_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification; 
  


----kpi_3.53(轮胎+蓄电池_二级)
 insert overwrite table  kpi_b_level_test 
     select  primary_classification,second_level_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_3.53(轮胎+蓄电池_车龄)
insert overwrite table  kpi_agetype_test 
   select  age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type; 
  


----kpi_3.53(轮胎+蓄电池_保内外)
insert overwrite table  kpi_bnbw_test 
  select  bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn; 
 


----kpi_3.53(轮胎+蓄电池_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select  primary_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification; 
  


----kpi_3.53(轮胎+蓄电池_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select  primary_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification; 
  
}

----kpi_3.53(轮胎+蓄电池_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select  primary_classification,second_level_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification; 
  


----kpi_3.53(轮胎+蓄电池_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select  primary_classification,second_level_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type in('DianC','LunT')) t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'  
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification; 
  


----kpi_3.54(其他高流失件_total)
insert overwrite table  kpi_total_test 
   select  
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'   
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
  


----kpi_3.54(其他高流失件_一级)
insert overwrite table  kpi_a_level_test 
     select  primary_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'   
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification; 
  


----kpi_3.54(其他高流失件_二级)
insert overwrite table  kpi_b_level_test 
     select  primary_classification,second_level_classification,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
  from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'   
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_3.54(其他高流失件_车龄)
insert overwrite table  kpi_agetype_test 
   select  age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'   
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type; 
  


----kpi_3.54(其他高流失件_保内外)
insert overwrite table  kpi_bnbw_test 
  select  bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'   
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn; 
 

----kpi_3.54(其他高流失件_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select  primary_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification; 
  


----kpi_3.54(其他高流失件_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select  primary_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification; 
  


----kpi_3.54(其他高流失件_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select  primary_classification,second_level_classification, age_type,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification; 
  


----kpi_3.54(其他高流失件_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select  primary_classification,second_level_classification, bn,
   substr(tran_date(s.order_balance_date),1,7) as mon,
   count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
   s.asc_code
   from label_order s 
   left join (
    select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
    join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
    on t1.part_number=x.part_num and x.version=m1.version
    where x.type='QiT') t 
    on  s.order_number=t.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=t.month
    and s.asc_code=t.asc_code
    where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
    and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
    and s.MAINT_TYPE1<>'删除'
    group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification; 
  

----kpi_5.6(单车高流失件工单产值_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code; 
  


----kpi_5.6(单车高流失件工单产值_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
  


----kpi_5.6(单车高流失件工单产值_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_5.6(单车高流失件工单产值_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.6(单车高流失件工单产值_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.6(单车高流失件工单产值_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.6(单车高流失件工单产值_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.6(单车高流失件工单产值_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.6(单车高流失件工单产值_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version ) m
on s.asc_code=m.asc_code
  and s.order_number=m.order_number
  and  substr(tran_date(s.order_balance_date),1,7)=m.month
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'   
  and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  



----kpi_5.61(单车高流失件产值_轮胎_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code; 
  


----kpi_5.61(单车高流失件产值_轮胎_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
  


----kpi_5.61(单车高流失件产值_轮胎_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_5.61(单车高流失件产值_轮胎_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12
and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.61(单车高流失件产值_轮胎_保内外)
insert overwrite table  kpi_bnbw_test 
select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.61(单车高流失件产值_轮胎_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.61(单车高流失件产值_轮胎_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.61(单车高流失件产值_轮胎_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.61(单车高流失件产值_轮胎_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='LunT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.62(单车高流失件产值_蓄电池_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='DianC' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code; 
  


----kpi_5.62(单车高流失件产值_蓄电池_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
  from date_label t
join label_order s
 join (select distinct x.asc_code,x.order_number from part x
 join high_flow_parts y on x.part_number=y.part_num  
 where y.dtlabel>='${begin_date}' and y.type='DianC' ) m
   on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
  


----kpi_5.62(单车高流失件产值_蓄电池_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='DianC' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_5.62(单车高流失件产值_蓄电池_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='DianC' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.62(单车高流失件产值_蓄电池_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='DianC' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.62(单车高流失件产值_蓄电池_一级_车龄)
 insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='DianC' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.62(单车高流失件产值_蓄电池_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='DianC' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.62(单车高流失件产值_蓄电池_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='DianC' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.62(单车高流失件产值_蓄电池_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='DianC' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.63(单车高流失件产值_轮胎&蓄电池_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type in('DianC','LunT') ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.64(单车高流失件产值_其他_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code; 
  


----kpi_5.64(单车高流失件产值_其他_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
  


----kpi_5.64(单车高流失件产值_其他_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
  


----kpi_5.64(单车高流失件产值_其他_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.64(单车高流失件产值_其他_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.64(单车高流失件产值_其他_一级_车龄)
insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.64(单车高流失件产值_其他_一级_保内外)
insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  


----kpi_5.64(单车高流失件产值_其他_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 
  


----kpi_5.64(单车高流失件产值_其他_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(s.order_balance_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join (select distinct t1.asc_code,t1.order_number,m1.month from part t1 join high_flow_parts x
join (select month,version from mapping where fact_table='label_order' and dim_table='high_flow_parts') m1
on t1.part_number=x.part_num and x.version=m1.version  
where  x.type='QiT' ) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}'   
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 
  





----kpi_5.7(单车年精品附件产值_total)
insert overwrite table  kpi_total_test 
  select substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select  t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除' 
   group by substr(t.mon_label,1,7),s.asc_code; 


----kpi_5.7(单车年精品附件产值_一级)
insert overwrite table  kpi_a_level_test 
  select primary_classification,
  substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select  t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification; 
   
   

----kpi_5.7(单车年精品附件产值_二级)
insert overwrite table  kpi_b_level_test 
  select primary_classification,
  second_level_classification,
  substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification; 
   
   
----kpi_5.7(单车年精品附件产值_车龄)
insert overwrite table  kpi_agetype_test 
  select case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.7(单车年精品附件产值_保内外)
insert overwrite table  kpi_bnbw_test 
  select case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.7(单车年精品附件产值_一级_车龄)

insert overwrite table  kpi_a_agetype_test 
  select primary_classification,case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.7(单车年精品附件产值_一级_保内外)

insert overwrite table  kpi_a_bnbw_test 
  select primary_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 

----kpi_5.7(单车年精品附件产值_二级_车龄)
insert overwrite table  kpi_b_agetype_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
when mon_diff(t.mon_label,s.outdate)>=12 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
when mon_diff(t.mon_label,s.outdate)>=24 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
when mon_diff(t.mon_label,s.outdate)>=36 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
when mon_diff(t.mon_label,s.outdate)>=48 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
else '5+年' end ; 

----kpi_5.7(单车年精品附件产值_二级_保内外)
insert overwrite table  kpi_b_bnbw_test 
  select primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  sum(m.sales_amount)/count(distinct s.vin) as num,
  s.asc_code
from date_label t
join label_order s
join  (select t1.sales_amount,t1.asc_code,t1.order_number,m1.month from part t1 join enclosure x
join (select month,version from mapping where fact_table='label_order' and dim_table='enclosure') m1
on t1.part_number=x.part_num and x.version=m1.version) m
on s.asc_code=m.asc_code
    and s.order_number=m.order_number
    and  substr(tran_date(s.order_balance_date),1,7)=m.month
    and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
    and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
    and substr(t.mon_label,1,7)<='${end_date}' 
    and s.MAINT_TYPE1<>'删除'
   group by substr(t.mon_label,1,7),s.asc_code,primary_classification,
   second_level_classification,
   case when s.outdate='未知' then '未知'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
when s.outdate<'2013-10-01' and mon_diff(t.mon_label,s.outdate)>23 then '保外'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
when s.outdate>='2013-10-01' and mon_diff(t.mon_label,s.outdate)>35 then '保外'
else '' end ; 


    
    