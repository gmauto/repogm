----kpi_1.14(保养台次占比_total)
insert overwrite table kpi_total_tmp_8areas
select ----'1.14' as kpi,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_total_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_total_tmp_8areas_k1
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon ;

----kpi_1.14(保养台次占比_一级)
insert overwrite table kpi_a_level_tmp_8areas
select ----'1.14' as kpi,
 s.primary_classification,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_level_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_level_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification ;

----kpi_1.14(保养台次占比_二级)
insert overwrite table kpi_b_level_tmp_8areas
select ----'1.14' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_level_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_level_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification 
 and s.second_level_classification=t.second_level_classification;

----kpi_1.14(保养台次占比_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select ----'1.14' as kpi,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_agetype_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.age_type=t.age_type ;

----kpi_1.14(保养台次占比_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select ----'1.14' as kpi,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_bnbw_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.bn=t.bn ;

----kpi_1.14(保养台次占比_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select ----'1.14' as kpi,
 s.primary_classification,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_agetype_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.age_type=t.age_type ;

----kpi_1.14(保养台次占比_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select ----'1.14' as kpi,
 s.primary_classification,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_bnbw_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.bn=t.bn ;

----kpi_1.14(保养台次占比_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select ----'1.14' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_agetype_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 and s.age_type=t.age_type ;

----kpi_1.14(保养台次占比_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select ----'1.14' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_bnbw_tmp_8areas_k1 
where kpi='kpi_1_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 and s.bn=t.bn ;
 
----kpi_1.21(维修台次占比_total)
insert overwrite table kpi_total_tmp_8areas
select ----'1.21' as kpi,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_total_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_total_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon ;

----kpi_1.21(维修台次占比_一级)
insert overwrite table kpi_a_level_tmp_8areas
select ----'1.21' as kpi,
 s.primary_classification,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_level_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_level_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification ;

----kpi_1.21(维修台次占比_二级)
insert overwrite table kpi_b_level_tmp_8areas
select ----'1.21' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_level_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_level_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification 
 and s.second_level_classification=t.second_level_classification;

----kpi_1.21(维修台次占比_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select ----'1.21' as kpi,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_agetype_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.age_type=t.age_type ;

----kpi_1.21(维修台次占比_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select ----'1.21' as kpi,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_bnbw_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.bn=t.bn ;

----kpi_1.21(维修台次占比_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select ----'1.21' as kpi,
 s.primary_classification,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_agetype_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.age_type=t.age_type ;

----kpi_1.21(维修台次占比_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select ----'1.21' as kpi,
 s.primary_classification,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_bnbw_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.bn=t.bn ;

----kpi_1.21(维修台次占比_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select ----'1.21' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_agetype_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 and s.age_type=t.age_type ;

----kpi_1.21(维修台次占比_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select ----'1.21' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_bnbw_tmp_8areas_k1 
where kpi='kpi_1_2'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 and s.bn=t.bn ; 

----kpi_1.36(事故台次占比_total)
insert overwrite table kpi_total_tmp_8areas
select ----'1.36' as kpi,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_total_tmp_8areas_k1 
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_total_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon ;

----kpi_1.36(事故台次占比_一级)
insert overwrite table kpi_a_level_tmp_8areas
select ----'1.36' as kpi,
 s.primary_classification,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_level_tmp_8areas_k1 
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_level_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification ;

----kpi_1.36(事故台次占比_二级)
insert overwrite table kpi_b_level_tmp_8areas
select ----'1.36' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_level_tmp_8areas_k1 
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_level_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification 
 and s.second_level_classification=t.second_level_classification;

----kpi_1.36(事故台次占比_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select ----'1.36' as kpi,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_agetype_tmp_8areas_k1 
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.age_type=t.age_type ;

----kpi_1.36(事故台次占比_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select ----'1.36' as kpi,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_bnbw_tmp_8areas_k1 
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.bn=t.bn ;

----kpi_1.36(事故台次占比_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select ----'1.36' as kpi,
 s.primary_classification,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_agetype_tmp_8areas_k1 
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.age_type=t.age_type ;

----kpi_1.36(事故台次占比_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select ----'1.36' as kpi,
 s.primary_classification,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_bnbw_tmp_8areas_k1
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.bn=t.bn ;

----kpi_1.36(事故台次占比_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select ----'1.36' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_agetype_tmp_8areas_k1 
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 and s.age_type=t.age_type ;

----kpi_1.36(事故台次占比_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select ----'1.36' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_bnbw_tmp_8areas_k1 
where kpi='kpi_1_3'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 and s.bn=t.bn ;
 
----kpi_1.41(索赔台次占比_total)
insert overwrite table kpi_total_tmp_8areas
select ----'1.41' as kpi,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_total_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_total_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon ;

----kpi_1.41(索赔台次占比_一级)
insert overwrite table kpi_a_level_tmp_8areas
select ----'1.41' as kpi,
 s.primary_classification,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_level_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_level_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification ;

----kpi_1.41(索赔台次占比_二级)
insert overwrite table kpi_b_level_tmp_8areas
select ----'1.41' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_level_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_level_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification 
 and s.second_level_classification=t.second_level_classification;

----kpi_1.41(索赔台次占比_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select ----'1.41' as kpi,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_agetype_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.age_type=t.age_type ;

----kpi_1.41(索赔台次占比_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select ----'1.41' as kpi,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_bnbw_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.bn=t.bn ;

----kpi_1.41(索赔台次占比_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select ----'1.41' as kpi,
 s.primary_classification,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_agetype_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.age_type=t.age_type ;

----kpi_1.41(索赔台次占比_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select ----'1.41' as kpi,
 s.primary_classification,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_a_bnbw_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_a_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.bn=t.bn ;

----kpi_1.41(索赔台次占比_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select ----'1.41' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.age_type,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_agetype_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_agetype_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 and s.age_type=t.age_type ;

----kpi_1.41(索赔台次占比_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select ----'1.41' as kpi,
 s.primary_classification,
 s.second_level_classification,
 s.bn,
 s.mon,
 s.num as num,t.num as den,
 s.asc_code
from (
select * from kpi_b_bnbw_tmp_8areas_k1 
where kpi='kpi_1_4'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) s,(
select * from kpi_b_bnbw_tmp_8areas_k1 
where kpi='kpi_1'
 and mon>='${begin_date}'
 and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
 and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification
 and s.bn=t.bn ;
 

----kpi_4(客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
 
 

----kpi_4(客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select s.primary_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification;
 
 
----kpi_4(客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select s.primary_classification,
s.second_level_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
s.second_level_classification;
 
 

----kpi_4(客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type;


----kpi_4(客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn;


----kpi_4(客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification;



----kpi_4(客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification;

----kpi_4(客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
s.second_level_classification;


----kpi_4(客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and s.claim=''
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
s.second_level_classification;



----kpi_4.1(保养客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
 
 

----kpi_4.1(保养客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select s.primary_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification;
 
 
----kpi_4.1(保养客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select s.primary_classification,
s.second_level_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
s.second_level_classification;
 
 

----kpi_4.1(保养客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type;


----kpi_4.1(保养客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn;


----kpi_4.1(保养客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification;



----kpi_4.1(保养客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification;

----kpi_4.1(保养客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
s.second_level_classification;


----kpi_4.1(保养客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
s.second_level_classification;


----kpi_4.2(维修客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
 

----kpi_4.2(维修客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select s.primary_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification;
 
 
----kpi_4.2(维修客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select s.primary_classification,
s.second_level_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
s.second_level_classification;
 
 

----kpi_4.2(维修客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type;


----kpi_4.2(维修客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn;


----kpi_4.2(维修客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification;



----kpi_4.2(维修客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification;

----kpi_4.2(维修客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
s.second_level_classification;


----kpi_4.2(维修客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
s.second_level_classification;


----kpi_4.3(事故客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
 
 

----kpi_4.3(事故客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select s.primary_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification;
 
 
----kpi_4.3(事故客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select s.primary_classification,
s.second_level_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
s.second_level_classification;
 
 

----kpi_4.3(事故客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type;


----kpi_4.3(事故客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn;


----kpi_4.3(事故客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification;



----kpi_4.3(事故客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification;

----kpi_4.3(事故客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
s.second_level_classification;


----kpi_4.3(事故客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(order_balance_amount) as num,count(distinct vin,tran_date(s.order_balance_date)) as den,
s.asc_code
from ${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
s.second_level_classification;


----kpi_4.31(799元以下事故客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date)
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code;
 
 

----kpi_4.31(799元以下事故客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code,primary_classification;
 
 
----kpi_4.31(799元以下事故客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification,
second_level_classification
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code,primary_classification,
second_level_classification;
 
 

----kpi_4.31(799元以下事故客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select age_type,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code,age_type;


----kpi_4.31(799元以下事故客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select bn,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code,bn;


----kpi_4.31(799元以下事故客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,primary_classification
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code,age_type,primary_classification;



----kpi_4.31(799元以下事故客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,primary_classification
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code,bn,primary_classification;

----kpi_4.31(799元以下事故客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,
second_level_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,
primary_classification,second_level_classification
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code,age_type,
primary_classification,second_level_classification;


----kpi_4.31(799元以下事故客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,
second_level_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,
primary_classification,second_level_classification
) s where sumamount<800
group by substr(order_balance_date,1,7),asc_code,bn,
primary_classification,second_level_classification;



----kpi_4.32(800-1999元事故客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date)
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code;
 
 

----kpi_4.32(800-1999元事故客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code,primary_classification;
 
 
----kpi_4.32(800-1999元事故客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification,
second_level_classification
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code,primary_classification,
second_level_classification;
 
 

----kpi_4.32(800-1999元事故客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select age_type,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code,age_type;


----kpi_4.32(800-1999元事故客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select bn,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code,bn;


----kpi_4.32(800-1999元事故客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,primary_classification
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code,age_type,primary_classification;



----kpi_4.32(800-1999元事故客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,primary_classification
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code,bn,primary_classification;

----kpi_4.32(800-1999元事故客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,
second_level_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,
primary_classification,second_level_classification
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code,age_type,
primary_classification,second_level_classification;


----kpi_4.32(800-1999元事故客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,
second_level_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,
primary_classification,second_level_classification
) s where sumamount>=800 and sumamount<2000
group by substr(order_balance_date,1,7),asc_code,bn,
primary_classification,second_level_classification;


----kpi_4.33(2000-4999元事故客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date)
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code;
 
 

----kpi_4.33(2000-4999元事故客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code,primary_classification;
 
 
----kpi_4.33(2000-4999元事故客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification,
second_level_classification
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code,primary_classification,
second_level_classification;
 
 

----kpi_4.33(2000-4999元事故客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select age_type,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code,age_type;


----kpi_4.33(2000-4999元事故客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select bn,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code,bn;


----kpi_4.33(2000-4999元事故客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,primary_classification
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code,age_type,primary_classification;



----kpi_4.33(2000-4999元事故客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,primary_classification
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code,bn,primary_classification;

----kpi_4.33(2000-4999元事故客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,
second_level_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,
primary_classification,second_level_classification
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code,age_type,
primary_classification,second_level_classification;


----kpi_4.33(2000-4999元事故客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,
second_level_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,
primary_classification,second_level_classification
) s where sumamount>=2000 and sumamount<5000
group by substr(order_balance_date,1,7),asc_code,bn,
primary_classification,second_level_classification; 


----kpi_4.34(5000-9999元事故客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date)
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code;
 
 

----kpi_4.34(5000-9999元事故客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code,primary_classification;
 
 
----kpi_4.34(5000-9999元事故客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification,
second_level_classification
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code,primary_classification,
second_level_classification;
 
 

----kpi_4.34(5000-9999元事故客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select age_type,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code,age_type;


----kpi_4.34(5000-9999元事故客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select bn,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code,bn;


----kpi_4.34(5000-9999元事故客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,primary_classification
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code,age_type,primary_classification;



----kpi_4.34(5000-9999元事故客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,primary_classification
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code,bn,primary_classification;

----kpi_4.34(5000-9999元事故客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,
second_level_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,
primary_classification,second_level_classification
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code,age_type,
primary_classification,second_level_classification;


----kpi_4.34(5000-9999元事故客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,
second_level_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,
primary_classification,second_level_classification
) s where sumamount>=5000 and sumamount<10000
group by substr(order_balance_date,1,7),asc_code,bn,
primary_classification,second_level_classification;


----kpi_4.35(10000元以上事故客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date)
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code;
 
 

----kpi_4.35(10000元以上事故客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code,primary_classification;
 
 
----kpi_4.35(10000元以上事故客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,primary_classification,second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),primary_classification,
second_level_classification
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code,primary_classification,
second_level_classification;
 
 

----kpi_4.35(10000元以上事故客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select age_type,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code,age_type;


----kpi_4.35(10000元以上事故客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select bn,substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code,bn;


----kpi_4.35(10000元以上事故客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,primary_classification
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code,age_type,primary_classification;



----kpi_4.35(10000元以上事故客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,primary_classification
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code,bn,primary_classification;

----kpi_4.35(10000元以上事故客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,
second_level_classification,
age_type,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,age_type,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),age_type,
primary_classification,second_level_classification
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code,age_type,
primary_classification,second_level_classification;


----kpi_4.35(10000元以上事故客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,
second_level_classification,
bn,
substr(order_balance_date,1,7) as mon,
sum(sumamount) as num,count(distinct vin,order_balance_date) as den,
asc_code
from (
select s.asc_code,bn,primary_classification,
second_level_classification,
s.vin,
tran_date(order_balance_date) as order_balance_date,
sum(order_balance_amount) as sumamount 
from 
${pub_db}.label_order s
where s.MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by s.asc_code,s.vin,tran_date(order_balance_date),bn,
primary_classification,second_level_classification
) s where sumamount>=10000
group by substr(order_balance_date,1,7),asc_code,bn,
primary_classification,second_level_classification;



----kpi_4.4(索赔客单价_total)
insert overwrite table kpi_total_tmp_8areas
select substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
 
 

----kpi_4.4(索赔客单价_一级)
insert overwrite table kpi_a_level_tmp_8areas
select s.primary_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification;
 
 
----kpi_4.4(索赔客单价_二级)
insert overwrite table kpi_b_level_tmp_8areas
select s.primary_classification,
s.second_level_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification;
 
 

----kpi_4.4(索赔客单价_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type;


----kpi_4.4(索赔客单价_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn;


----kpi_4.4(索赔客单价_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification;



----kpi_4.4(索赔客单价_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification;

----kpi_4.4(索赔客单价_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
s.second_level_classification;


----kpi_4.4(索赔客单价_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,
s.second_level_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
sum(t.claim_accepted_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
s.asc_code
 from ${pub_db}.label_order s,${pub_db}.claim_uniq t 
where s.MAINT_TYPE1<>'删除'
and s.asc_code=t.asc_code
and s.claim_order_number=t.claim_order_number
and s.claim='1' and t.claim_result in('审核同意','33')
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
s.second_level_classification;

----kpi_4.11(平价机油_total)
insert overwrite table kpi_total_tmp_8areas 
 select substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
 


----kpi_4.11(平价机油_一级)
insert overwrite table kpi_a_level_tmp_8areas 
 select s.primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
 


----kpi_4.11(平价机油_二级)
insert overwrite table kpi_b_level_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
 s.second_level_classification; 
 


----kpi_4.11(平价机油_车龄)
insert overwrite table kpi_agetype_tmp_8areas 
 select s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
 


----kpi_4.11(平价机油_保内外)
insert overwrite table kpi_bnbw_tmp_8areas 
 select s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
 


----kpi_4.11(平价机油_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas 
 select s.primary_classification,
 s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification; 
 


----kpi_4.11(平价机油_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas 
 select s.primary_classification,
 s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification; 
 


----kpi_4.11(平价机油_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
 s.second_level_classification; 
 


----kpi_4.11(平价机油_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='低端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
 s.second_level_classification; 
 


----kpi_4.12(中端机油_total)
insert overwrite table kpi_total_tmp_8areas 
 select substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
 


----kpi_4.12(中端机油_一级)
insert overwrite table kpi_a_level_tmp_8areas 
 select s.primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
 


----kpi_4.12(中端机油_二级)
insert overwrite table kpi_b_level_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
 s.second_level_classification; 
 


----kpi_4.12(中端机油_车龄)
insert overwrite table kpi_agetype_tmp_8areas 
 select s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
 


----kpi_4.12(中端机油_保内外)
insert overwrite table kpi_bnbw_tmp_8areas 
 select s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
 


----kpi_4.12(中端机油_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas 
 select s.primary_classification,
 s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification; 
 


----kpi_4.12(中端机油_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas 
 select s.primary_classification,
 s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification; 
 


----kpi_4.12(中端机油_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
 s.second_level_classification; 
 


----kpi_4.12(中端机油_二级_保内外)
 insert overwrite table kpi_b_bnbw_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='中端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
 s.second_level_classification; 
 


----kpi_4.13(高端机油_total)
insert overwrite table kpi_total_tmp_8areas 
 select substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code; 
 


----kpi_4.13(高端机油_一级)
insert overwrite table kpi_a_level_tmp_8areas 
 select s.primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification; 
 


----kpi_4.13(高端机油_二级)
insert overwrite table kpi_b_level_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,
 s.second_level_classification; 
 


----kpi_4.13(高端机油_车龄)
insert overwrite table kpi_agetype_tmp_8areas 
 select s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type; 
 


----kpi_4.13(高端机油_保内外)
insert overwrite table kpi_bnbw_tmp_8areas 
 select s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn; 
 


----kpi_4.13(高端机油_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas 
 select s.primary_classification,
 s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification; 
 


----kpi_4.13(高端机油_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas 
 select s.primary_classification,
 s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification; 
 


----kpi_4.13(高端机油_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 s.age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type,s.primary_classification,
 s.second_level_classification; 
 


----kpi_4.13(高端机油_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas 
 select s.primary_classification,
 s.second_level_classification,
 s.bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 sum(order_balance_amount) as num,count(distinct s.vin,tran_date(s.order_balance_date)) as den,
 s.asc_code
 from ${pub_db}.label_order s join 
 (
 select distinct t1.asc_code,t1.order_number,m.month from ${pub_db}.part t1
 join (select * from ${pub_db}.engine_oil where type='高端') p
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='engine_oil') m
 on t1.part_number=p.part_num
 and p.version=m.version
 ) t
 on s.asc_code=t.asc_code
 and s.order_number=t.order_number
 and substr(tran_date(s.order_balance_date),1,7)=t.month
 where s.MAINT_TYPE1='保养'
 and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(order_balance_date),1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn,s.primary_classification,
 s.second_level_classification; 

 
----kpi_5(单车产值_total)
insert overwrite table kpi_total_tmp_8areas
select substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den
,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),s.asc_code;
 
 

----kpi_5(单车产值_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7) 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code;
 
 
----kpi_5(单车产值_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),primary_classification,second_level_classification,s.asc_code;
 
 

----kpi_5(单车产值_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5(单车产值_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5(单车产值_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;



----kpi_5(单车产值_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5(单车产值_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5(单车产值_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim=''
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1<>'删除'
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;
	
	
----kpi_5.1(单车年保养产值_total)
insert overwrite table kpi_total_tmp_8areas
select substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),s.asc_code;
 
 

----kpi_5.1(单车年保养产值_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code;
 
 
----kpi_5.1(单车年保养产值_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),primary_classification,second_level_classification,s.asc_code;
 
 

----kpi_5.1(单车年保养产值_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.1(单车年保养产值_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.1(单车年保养产值_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;
 
----kpi_5.1(单车年保养产值_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5.1(单车年保养产值_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.1(单车年保养产值_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and (s.first_maintnance='' or (s.first_maintnance='1' and s.order_balance_amount<>0))
 and s.MAINT_TYPE1='保养'
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

	
----kpi_5.2(单车年维修产值_total)
insert overwrite table kpi_total_tmp_8areas
select substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),s.asc_code; 

----kpi_5.2(单车年维修产值_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code;
 
 
----kpi_5.2(单车年维修产值_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),primary_classification,second_level_classification,s.asc_code;
 
 

----kpi_5.2(单车年维修产值_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.2(单车年维修产值_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.2(单车年维修产值_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;



----kpi_5.2(单车年维修产值_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5.2(单车年维修产值_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.2(单车年维修产值_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='维修'
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.3(单车年事故产值_total)
insert overwrite table kpi_total_tmp_8areas
select substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),s.asc_code;
 
 

----kpi_5.3(单车年事故产值_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code;
 
 
----kpi_5.3(单车年事故产值_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),primary_classification,second_level_classification,s.asc_code;
 
 

----kpi_5.3(单车年事故产值_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.3(单车年事故产值_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.3(单车年事故产值_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;



----kpi_5.3(单车年事故产值_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5.3(单车年事故产值_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.3(单车年事故产值_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(s.order_balance_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='事故'
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;



----kpi_5.4(单车年索赔产值_total)
insert overwrite table kpi_total_tmp_8areas
select substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),s.asc_code;
 
 

----kpi_5.4(单车年索赔产值_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code;
 
 
----kpi_5.4(单车年索赔产值_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
second_level_classification,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),primary_classification,second_level_classification,s.asc_code;
 
 

----kpi_5.4(单车年索赔产值_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.4(单车年索赔产值_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;


----kpi_5.4(单车年索赔产值_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;



----kpi_5.4(单车年索赔产值_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;

----kpi_5.4(单车年索赔产值_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;


----kpi_5.4(单车年索赔产值_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,second_level_classification,
case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
substr(t.mon_label,1,7) as mon,
sum(m.claim_accepted_amount) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
join ${pub_db}.claim_uniq m
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
 and s.asc_code=m.asc_code
 and s.claim_order_number=m.claim_order_number
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.claim='1' and s.MAINT_TYPE1<>'删除'
 and m.claim_result in('审核同意','33') 
 group by substr(t.mon_label,1,7),primary_classification,
 second_level_classification,s.asc_code,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end ;
	
	
----kpi_3.1(首保进站率_total)
insert overwrite table kpi_total_tmp_8areas
 select s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.vin,s.asc_code,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.vin,s.asc_code,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7) 
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon and  s.asc_code=t.asc_code
 group by s.mon,s.asc_code;

----kpi_3.1(首保进站率_一级)
insert overwrite table kpi_a_level_tmp_8areas
 select s.primary_classification,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.primary_classification,s.asc_code;
 
 
----kpi_3.1(首保进站率_二级)
insert overwrite table kpi_b_level_tmp_8areas
select s.primary_classification,s.second_level_classification,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.primary_classification,s.second_level_classification,s.asc_code;

----kpi_3.1(首保进站率_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.asc_code;


----kpi_3.1(首保进站率_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.asc_code;

----kpi_3.1(首保进站率_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
	s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,
 s.primary_classification,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.primary_classification,s.asc_code;

----kpi_3.1(首保进站率_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.primary_classification,s.asc_code;

----kpi_3.1(首保进站率_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
	s.primary_classification,
	s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,
 s.primary_classification,
 s.second_level_classification,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.primary_classification,s.second_level_classification,s.asc_code;

----kpi_3.1(首保进站率_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.primary_classification,s.second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.primary_classification,s.second_level_classification,s.asc_code;
 	

----kpi_3.2(首次付费保养进站率_total)
insert overwrite table kpi_total_tmp_8areas
select s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct 
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct 
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin and  s.asc_code=t.asc_code
 group by s.mon,s.asc_code ;
 
 
 

----kpi_3.2(首次付费保养进站率_一级)
insert overwrite table kpi_a_level_tmp_8areas
 select s.primary_classification,s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin 
 and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.primary_classification,s.asc_code;

----kpi_3.2(首次付费保养进站率_二级)
insert overwrite table kpi_b_level_tmp_8areas
 select s.primary_classification,s.second_level_classification,s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.primary_classification,s.second_level_classification,s.asc_code;

----kpi_3.2(首次付费保养进站率_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin 
 and s.age_type=t.age_type and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.asc_code;

----kpi_3.2(首次付费保养进站率_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin 
 and s.bn=t.bn and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.asc_code;

----kpi_3.2(首次付费保养进站率_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct s.primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct s.primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.primary_classification,s.asc_code;

----kpi_3.2(首次付费保养进站率_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct s.primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct s.primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin 
 and s.bn=t.bn and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.primary_classification,s.asc_code;

----kpi_3.2(首次付费保养进站率_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.primary_classification,s.second_level_classification;

----kpi_3.2(首次付费保养进站率_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
select distinct s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1
) s left join (
select distinct s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1='保养'
 and s.order_balance_amount>0
 ) t on  s.mon=t.mon and s.vin=t.vin 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.primary_classification,s.second_level_classification,s.asc_code;	
	
	
----kpi_3.1(首保进站率_total)
insert overwrite table kpi_total_tmp_8areas
 select s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon and  s.asc_code=t.asc_code
 group by s.mon,s.asc_code;

----kpi_3.1(首保进站率_一级)
insert overwrite table kpi_a_level_tmp_8areas
 select s.primary_classification,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon,s.asc_code 
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.primary_classification,s.asc_code;
 
 
----kpi_3.1(首保进站率_二级)
insert overwrite table kpi_b_level_tmp_8areas
select s.primary_classification,s.second_level_classification,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.primary_classification,s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.primary_classification,s.second_level_classification,s.asc_code;

----kpi_3.1(首保进站率_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.asc_code;


----kpi_3.1(首保进站率_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.asc_code;

----kpi_3.1(首保进站率_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
	s.primary_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,
 s.primary_classification,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.primary_classification,s.asc_code;

----kpi_3.1(首保进站率_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and s.primary_classification=t.primary_classification and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.primary_classification,s.asc_code;

----kpi_3.1(首保进站率_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select case when tran_date(s.invoice_date)='未知' then '未知'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
 when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
 and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
 else '5+年' end as age_type,
	s.primary_classification,
	s.second_level_classification,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 s.vin,
 substr(t.mon_label,1,7) as mon ,
 s.primary_classification,
 s.second_level_classification,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.age_type=t.age_type and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.primary_classification,s.second_level_classification,s.asc_code;

----kpi_3.1(首保进站率_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
 sum(case when t.vin is not null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select s.primary_classification,s.second_level_classification,s.asc_code,
 case when tran_date(s.invoice_date)='未知' then '未知'
 when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon 
from ${pub_db}.label_doss s
join ${pub_db}.date_label t
on substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.primary_classification<>''
 ) s left join( 
 select distinct s.primary_classification,s.second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 s.vin,
 substr(t.mon_label,1,7) as mon ,s.asc_code
from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and first_maintnance=1 
 ) t on  s.vin=t.vin and s.mon=t.mon 
 and s.bn=t.bn and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and  s.asc_code=t.asc_code
 group by s.mon,s.bn,s.primary_classification,s.second_level_classification,s.asc_code;
 	
	
	
----kpi_2.3(年进站保养频次_total)
insert overwrite table kpi_total_tmp_8areas
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),s.asc_code;
 

----kpi_2.3(年进站保养频次_一级)
insert overwrite table kpi_a_level_tmp_8areas
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code;

----kpi_2.3(年进站保养频次_二级)
insert overwrite table kpi_b_level_tmp_8areas
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),primary_classification,second_level_classification,s.asc_code;

----kpi_2.3(年进站保养频次_车龄)
insert overwrite table kpi_agetype_tmp_8areas
select case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.3(年进站保养频次_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2.3(年进站保养频次_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.3(年进站保养频次_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),primary_classification,s.asc_code,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;

----kpi_2.3(年进站保养频次_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),primary_classification,second_level_classification,s.asc_code,case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end ;

----kpi_2.3(年进站保养频次_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date)) as num,count(distinct s.vin) as den,s.asc_code
from ${pub_db}.label_order s 
 join ${pub_db}.date_label t
 on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}' 
 and s.MAINT_TYPE1='保养' 
 group by substr(t.mon_label,1,7),primary_classification,second_level_classification,s.asc_code,case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
 when s.outdate<'2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>23 then '保外'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
 when s.outdate>='2013-10-01' 
 and mon_diff(t.mon_label,s.outdate)>35 then '保外'
 else '' end ;
 
----kpi_3.61(一年客户流失率_total)
insert overwrite table kpi_total_tmp_8areas
 select s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct 
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct 
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon and s.vin=t.vin on  and s.asc_code=t.asc_code
 group by s.mon,s.asc_code;
 
 

----kpi_3.61(一年客户流失率_一级)
insert overwrite table kpi_a_level_tmp_8areas
 select s.primary_classification,s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct s.primary_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct s.primary_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon and s.primary_classification=t.primary_classification and s.vin=t.vin and s.asc_code=t.asc_code
 group by s.mon,s.primary_classification,s.asc_code;
 
 
----kpi_3.61(一年客户流失率_二级)
insert overwrite table kpi_b_level_tmp_8areas
 select s.primary_classification,s.second_level_classification,s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct s.primary_classification,second_level_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct s.primary_classification,second_level_classification,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin and s.asc_code=t.asc_code
 group by s.mon,s.primary_classification,s.second_level_classification,s.asc_code;
 
 

----kpi_3.61(一年客户流失率_车龄)
insert overwrite table kpi_agetype_tmp_8areas
 select s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon and s.age_type=t.age_type and s.vin=t.vin and s.asc_code=t.asc_code
 group by s.mon,s.age_type,s.asc_code;

----kpi_3.61(一年客户流失率_保内外)
insert overwrite table kpi_bnbw_tmp_8areas
select s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon and s.bn=t.bn and s.vin=t.vin and s.asc_code=t.asc_code
 group by s.mon,s.bn,s.asc_code;

----kpi_3.61(一年客户流失率_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas
select s.primary_classification,s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct primary_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon and s.age_type=t.age_type 
 and s.primary_classification=t.primary_classification and s.vin=t.vin and s.asc_code=t.asc_code
 group by s.primary_classification,s.age_type,s.mon,s.asc_code;

----kpi_3.61(一年客户流失率_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas
select s.primary_classification,s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct primary_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon and s.bn=t.bn
 and s.primary_classification=t.primary_classification and s.vin=t.vin and s.asc_code=t.asc_code
 group by s.primary_classification,s.bn,s.mon,s.asc_code;

----kpi_3.61(一年客户流失率_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when mon_diff(t.mon_label,s.outdate)<=11 then '0-1年'
 when mon_diff(t.mon_label,s.outdate)>=12
 and mon_diff(t.mon_label,s.outdate)<=23 then '1-2年'
 when mon_diff(t.mon_label,s.outdate)>=24
 and mon_diff(t.mon_label,s.outdate)<=35 then '2-3年'
 when mon_diff(t.mon_label,s.outdate)>=36
 and mon_diff(t.mon_label,s.outdate)<=47 then '3-4年'
 when mon_diff(t.mon_label,s.outdate)>=48
 and mon_diff(t.mon_label,s.outdate)<=59 then '4-5年'
 else '5+年' end as age_type,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon and s.age_type=t.age_type 
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin and s.asc_code=t.asc_code
 group by s.primary_classification,
 s.second_level_classification,s.age_type,s.mon,s.asc_code;

----kpi_3.61(一年客户流失率_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
 sum(case when t.vin is null then 1 else 0 end) as num,count(s.vin) as den,s.asc_code
 from (
 select distinct primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 and s.order_balance_amount>0
 ) s left join 
 (
 select distinct primary_classification,second_level_classification,
 case when s.outdate='未知' then '未知'
 when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,s.outdate)>35 then '保外'
	else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 s.vin,s.asc_code
 from ${pub_db}.label_order s 
join ${pub_db}.date_label t
on substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
 and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
where substr(t.mon_label,1,7)>='${begin_date}'
 and substr(t.mon_label,1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除'
 ) t on  s.mon=t.mon and s.bn=t.bn
 and s.primary_classification=t.primary_classification
 and s.second_level_classification=t.second_level_classification and s.vin=t.vin and s.asc_code=t.asc_code
 group by s.primary_classification,
 s.second_level_classification,s.bn,s.mon,s.asc_code;	
	
	
----kpi_3.4(养护品着装率_total)
insert overwrite table kpi_total_tmp_8areas 
 select 
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
 
----kpi_3.4(养护品着装率_一级)
insert overwrite table kpi_a_level_tmp_8areas 
 select primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),primary_classification,s.asc_code;

----kpi_3.4(养护品着装率_二级)
insert overwrite table kpi_b_level_tmp_8areas 
 select primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),primary_classification,second_level_classification,s.asc_code;

----kpi_3.4(养护品着装率_车龄)
insert overwrite table kpi_agetype_tmp_8areas 
 select age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),age_type,s.asc_code;

----kpi_3.4(养护品着装率_保内外)
insert overwrite table kpi_bnbw_tmp_8areas 
 select bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),bn,s.asc_code;

----kpi_3.4(养护品着装率_一级_车龄)
insert overwrite table kpi_a_agetype_tmp_8areas 
 select primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),age_type,primary_classification,s.asc_code;


----kpi_3.4(养护品着装率_一级_保内外)
insert overwrite table kpi_a_bnbw_tmp_8areas 
 select primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),bn,primary_classification,s.asc_code;


----kpi_3.4(养护品着装率_二级_车龄)
insert overwrite table kpi_b_agetype_tmp_8areas 
 select primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),age_type,primary_classification,second_level_classification,s.asc_code;


----kpi_3.4(养护品着装率_二级_保内外)
insert overwrite table kpi_b_bnbw_tmp_8areas 
 select primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when tasc_code is not null then s.vin else null end) as num,count(distinct s.vin) as den,s.asc_code
 from
 (select s.*,t.asc_code as tasc_code
 from ${pub_db}.label_order s 
 left join (
 select distinct t.asc_code,t.order_number,m1.month from ${pub_db}.part t join ${pub_db}.maintnance x
 join (select month,version from ${pub_db}.mapping where fact_table='label_order' and dim_table='maintnance') m1
 on t.part_number=x.part_num 
 and x.version=m1.version 
 and substr(tran_date(t.order_balance_date),1,7)=m1.month
 ) t 
 on s.order_number=t.order_number
 and s.asc_code=t.asc_code
 where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
 and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
 and s.MAINT_TYPE1<>'删除' )s
 group by substr(tran_date(s.order_balance_date),1,7),bn,primary_classification,second_level_classification,s.asc_code;

 


