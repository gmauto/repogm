----加载日期转换函数
add jar /home/ipsos/general/bin/transform-date.jar;
CREATE TEMPORARY FUNCTION tran_date AS 'TransformDate';

----kpi_1(进站台次_total)
insert overwrite table  kpi_total
select ----'1' as kpi,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code;

----kpi_1(进站台次_一级)
insert overwrite table  kpi_a_level
select ----'1' as kpi,
primary_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification;

----kpi_1(进站台次_二级)
insert overwrite table  kpi_b_level
select ----'1' as kpi,
primary_classification,
second_level_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification;

----kpi_1(进站台次_车龄)
insert overwrite table  kpi_agetype
select ----'1' as kpi,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,age_type;

----kpi_1(进站台次_保内外)
insert overwrite table  kpi_bnbw
select ----'1' as kpi,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,bn;

----kpi_1(进站台次_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1' as kpi,
primary_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,age_type;

----kpi_1(进站台次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1' as kpi,
primary_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,bn;

----kpi_1(进站台次_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,age_type;

----kpi_1(进站台次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1' as kpi,
primary_classification,
second_level_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1<>'删除'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,bn;


----kpi_1.1(保养台次_total)
insert overwrite table  kpi_total
select ----'1.1' as kpi,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code;

----kpi_1.1(保养台次_一级)
insert overwrite table  kpi_a_level
select ----'1.1' as kpi,
primary_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification;

----kpi_1.1(保养台次_二级)
insert overwrite table  kpi_b_level
select ----'1.1' as kpi,
primary_classification,
second_level_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.1(保养台次_车龄)
insert overwrite table  kpi_agetype
select ----'1.1' as kpi,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,age_type;

----kpi_1.1(保养台次_保内外)
insert overwrite table  kpi_bnbw
select ----'1.1' as kpi,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,bn;

----kpi_1.1(保养台次_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.1' as kpi,
primary_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,age_type;

----kpi_1.1(保养台次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.1' as kpi,
primary_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,bn;

----kpi_1.1(保养台次_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.1' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,age_type;

----kpi_1.1(保养台次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.1' as kpi,
primary_classification,
second_level_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='保养'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,bn;


----kpi_1.11(平价机油台次_total)
insert overwrite table  kpi_total
select ----'1.11' as kpi,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;

----kpi_1.11(平价机油台次_一级)
insert overwrite table  kpi_a_level
select ----'1.11' as kpi,
s.primary_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification;

----kpi_1.11(平价机油台次_二级)
insert overwrite table  kpi_b_level
select ----'1.11' as kpi,
s.primary_classification,
s.second_level_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification;

----kpi_1.11(平价机油台次_车龄)
insert overwrite table  kpi_agetype
select ----'1.11' as kpi,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type;

----kpi_1.11(平价机油台次_保内外)
insert overwrite table  kpi_bnbw
select ----'1.11' as kpi,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn;

----kpi_1.11(平价机油台次_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.11' as kpi,
s.primary_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.age_type;

----kpi_1.11(平价机油台次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.11' as kpi,
s.primary_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.bn;

----kpi_1.11(平价机油台次_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.11' as kpi,
s.primary_classification,
s.second_level_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.age_type;

----kpi_1.11(平价机油台次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.11' as kpi,
s.primary_classification,
s.second_level_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='低端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.bn;

----kpi_1.12(中端机油台次_total)
insert overwrite table  kpi_total
select ----'1.12' as kpi,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;

----kpi_1.12(中端机油台次_一级)
insert overwrite table  kpi_a_level
select ----'1.12' as kpi,
s.primary_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification;

----kpi_1.12(中端机油台次_二级)
insert overwrite table  kpi_b_level
select ----'1.12' as kpi,
s.primary_classification,
s.second_level_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification;

----kpi_1.12(中端机油台次_车龄)
insert overwrite table  kpi_agetype
select ----'1.12' as kpi,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type;

----kpi_1.12(中端机油台次_保内外)
insert overwrite table  kpi_bnbw
select ----'1.12' as kpi,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn;

----kpi_1.12(中端机油台次_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.12' as kpi,
s.primary_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.age_type;

----kpi_1.12(中端机油台次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.12' as kpi,
s.primary_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.bn;

----kpi_1.12(中端机油台次_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.12' as kpi,
s.primary_classification,
s.second_level_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.age_type;

----kpi_1.12(中端机油台次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.12' as kpi,
s.primary_classification,
s.second_level_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='中端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.bn;

----kpi_1.13(高端机油台次_total)
insert overwrite table  kpi_total
select ----'1.13' as kpi,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;

----kpi_1.13(高端机油台次_一级)
insert overwrite table  kpi_a_level
select ----'1.13' as kpi,
s.primary_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification;

----kpi_1.13(高端机油台次_二级)
insert overwrite table  kpi_b_level
select ----'1.13' as kpi,
s.primary_classification,
s.second_level_classification,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification;

----kpi_1.13(高端机油台次_车龄)
insert overwrite table  kpi_agetype
select ----'1.13' as kpi,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.age_type;

----kpi_1.13(高端机油台次_保内外)
insert overwrite table  kpi_bnbw
select ----'1.13' as kpi,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.bn;

----kpi_1.13(高端机油台次_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.13' as kpi,
s.primary_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.age_type;

----kpi_1.13(高端机油台次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.13' as kpi,
s.primary_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.bn;

----kpi_1.13(高端机油台次_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.13' as kpi,
s.primary_classification,
s.second_level_classification,
s.age_type,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.age_type;

----kpi_1.13(高端机油台次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.13' as kpi,
s.primary_classification,
s.second_level_classification,
s.bn,
substr(tran_date(s.order_balance_date),1,7) as mon,
count(distinct s.vin,tran_date(s.order_balance_date)) as cnt,
s.asc_code
 from label_order s,part t,engine_oil m
where s.MAINT_TYPE1='保养'
and s.asc_code=t.asc_code
and s.order_number=t.order_number
and t.part_number=m.part_num
and m.type='高端'
and substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,s.primary_classification,s.second_level_classification,s.bn;


----kpi_1.14(保养台次占比_total)
insert overwrite table  kpi_total
select ----'1.14' as kpi,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_total 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_total 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon ;

----kpi_1.14(保养台次占比_一级)
insert overwrite table  kpi_a_level
select ----'1.14' as kpi,
 s.a_level,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_level 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_level 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level ;

----kpi_1.14(保养台次占比_二级)
insert overwrite table  kpi_b_level
select ----'1.14' as kpi,
 s.a_level,
 s.b_level,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_level 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_level 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level 
  and s.b_level=t.b_level;

----kpi_1.14(保养台次占比_车龄)
insert overwrite table  kpi_agetype
select ----'1.14' as kpi,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_agetype 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.age_type=t.age_type ;

----kpi_1.14(保养台次占比_保内外)
insert overwrite table  kpi_bnbw
select ----'1.14' as kpi,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_bnbw 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.bnbw=t.bnbw ;

----kpi_1.14(保养台次占比_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.14' as kpi,
 s.a_level,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_agetype 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.age_type=t.age_type ;

----kpi_1.14(保养台次占比_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.14' as kpi,
 s.a_level,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_bnbw 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.bnbw=t.bnbw ;

----kpi_1.14(保养台次占比_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.14' as kpi,
 s.a_level,
 s.b_level,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_agetype 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.b_level=t.b_level
  and s.age_type=t.age_type ;

----kpi_1.14(保养台次占比_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.14' as kpi,
 s.a_level,
 s.b_level,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_bnbw 
where kpi='kpi_1_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.b_level=t.b_level
  and s.bnbw=t.bnbw ;
  
----kpi_1.2(维修台次_total)
insert overwrite table  kpi_total
select ----'1.2' as kpi,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code;

----kpi_1.2(维修台次_一级)
insert overwrite table  kpi_a_level
select ----'1.2' as kpi,
primary_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification;

----kpi_1.2(维修台次_二级)
insert overwrite table  kpi_b_level
select ----'1.2' as kpi,
primary_classification,
second_level_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.2(维修台次_车龄)
insert overwrite table  kpi_agetype
select ----'1.2' as kpi,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,age_type;

----kpi_1.2(维修台次_保内外)
insert overwrite table  kpi_bnbw
select ----'1.2' as kpi,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,bn;

----kpi_1.2(维修台次_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.2' as kpi,
primary_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,age_type;

----kpi_1.2(维修台次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.2' as kpi,
primary_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,bn;

----kpi_1.2(维修台次_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.2' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,age_type;

----kpi_1.2(维修台次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.2' as kpi,
primary_classification,
second_level_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='维修'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,bn;


----kpi_1.21(维修台次占比_total)
insert overwrite table  kpi_total
select ----'1.21' as kpi,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_total 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_total 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon ;

----kpi_1.21(维修台次占比_一级)
insert overwrite table  kpi_a_level
select ----'1.21' as kpi,
 s.a_level,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_level 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_level 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level ;

----kpi_1.21(维修台次占比_二级)
insert overwrite table  kpi_b_level
select ----'1.21' as kpi,
 s.a_level,
 s.b_level,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_level 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_level 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level 
  and s.b_level=t.b_level;

----kpi_1.21(维修台次占比_车龄)
insert overwrite table  kpi_agetype
select ----'1.21' as kpi,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_agetype 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.age_type=t.age_type ;

----kpi_1.21(维修台次占比_保内外)
insert overwrite table  kpi_bnbw
select ----'1.21' as kpi,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_bnbw 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.bnbw=t.bnbw ;

----kpi_1.21(维修台次占比_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.21' as kpi,
 s.a_level,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_agetype 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.age_type=t.age_type ;

----kpi_1.21(维修台次占比_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.21' as kpi,
 s.a_level,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_bnbw 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.bnbw=t.bnbw ;

----kpi_1.21(维修台次占比_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.21' as kpi,
 s.a_level,
 s.b_level,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_agetype 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.b_level=t.b_level
  and s.age_type=t.age_type ;

----kpi_1.21(维修台次占比_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.21' as kpi,
 s.a_level,
 s.b_level,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_bnbw 
where kpi='kpi_1_2'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.b_level=t.b_level
  and s.bnbw=t.bnbw ;
  

----kpi_1.3(事故台次_total)
insert overwrite table  kpi_total
select ----'1.3' as kpi,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code;

----kpi_1.3(事故台次_一级)
insert overwrite table  kpi_a_level
select ----'1.3' as kpi,
primary_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification;

----kpi_1.3(事故台次_二级)
insert overwrite table  kpi_b_level
select ----'1.3' as kpi,
primary_classification,
second_level_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.3(事故台次_车龄)
insert overwrite table  kpi_agetype
select ----'1.3' as kpi,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,age_type;

----kpi_1.3(事故台次_保内外)
insert overwrite table  kpi_bnbw
select ----'1.3' as kpi,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,bn;

----kpi_1.3(事故台次_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.3' as kpi,
primary_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,age_type;

----kpi_1.3(事故台次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.3' as kpi,
primary_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,bn;

----kpi_1.3(事故台次_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.3' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,age_type;

----kpi_1.3(事故台次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.3' as kpi,
primary_classification,
second_level_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,bn;


----kpi_1.31(799元以下事故_total)
insert overwrite table  kpi_total
select ----'1.31' as kpi,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin
    ) s 
where sumamount<800
group by substr(order_date,1,7),asc_code;

----kpi_1.31(799元以下事故_一级)
insert overwrite table  kpi_a_level
select ----'1.31' as kpi,
primary_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification) s 
where sumamount<800
group by substr(order_date,1,7),asc_code,primary_classification;

----kpi_1.31(799元以下事故_二级)
insert overwrite table  kpi_b_level
select ----'1.31' as kpi,
primary_classification,
second_level_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification,second_level_classification) s 
where sumamount<800
group by substr(order_date,1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.31(799元以下事故_车龄)
insert overwrite table  kpi_agetype
select ----'1.31' as kpi,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type) s 
where sumamount<800
group by substr(order_date,1,7),asc_code,age_type;

----kpi_1.31(799元以下事故_保内外)
insert overwrite table  kpi_bnbw
select ----'1.31' as kpi,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn) s 
where sumamount<800
group by substr(order_date,1,7),asc_code,bn;

----kpi_1.31(799元以下事故_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.31' as kpi,
primary_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification) s 
where sumamount<800
group by substr(order_date,1,7),asc_code,age_type,primary_classification;

----kpi_1.31(799元以下事故_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.31' as kpi,
primary_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification) s 
where sumamount<800
group by substr(order_date,1,7),asc_code,bn,primary_classification;

----kpi_1.31(799元以下事故_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.31' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification,second_level_classification) s 
where sumamount<800
group by substr(order_date,1,7),asc_code,age_type,primary_classification,second_level_classification;

----kpi_1.31(799元以下事故_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.31' as kpi,
primary_classification,
second_level_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification,second_level_classification) s 
where sumamount<800
group by substr(order_date,1,7),asc_code,bn,primary_classification,second_level_classification;


----kpi_1.32(800-1999元事故_total)
insert overwrite table  kpi_total
select ----'1.32' as kpi,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin
    ) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code;

----kpi_1.32(800-1999元事故_一级)
insert overwrite table  kpi_a_level
select ----'1.32' as kpi,
primary_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code,primary_classification;

----kpi_1.32(800-1999元事故_二级)
insert overwrite table  kpi_b_level
select ----'1.32' as kpi,
primary_classification,
second_level_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification,second_level_classification) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.32(800-1999元事故_车龄)
insert overwrite table  kpi_agetype
select ----'1.32' as kpi,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code,age_type;

----kpi_1.32(800-1999元事故_保内外)
insert overwrite table  kpi_bnbw
select ----'1.32' as kpi,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code,bn;

----kpi_1.32(800-1999元事故_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.32' as kpi,
primary_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code,age_type,primary_classification;

----kpi_1.32(800-1999元事故_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.32' as kpi,
primary_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code,bn,primary_classification;

----kpi_1.32(800-1999元事故_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.32' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification,second_level_classification) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code,age_type,primary_classification,second_level_classification;

----kpi_1.32(800-1999元事故_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.32' as kpi,
primary_classification,
second_level_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification,second_level_classification) s 
where sumamount>=800 and sumamount<2000 
group by substr(order_date,1,7),asc_code,bn,primary_classification,second_level_classification;


----kpi_1.33(2000-4999元事故_total)
insert overwrite table  kpi_total
select ----'1.33' as kpi,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin
    ) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code;

----kpi_1.33(2000-4999元事故_一级)
insert overwrite table  kpi_a_level
select ----'1.33' as kpi,
primary_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code,primary_classification;

----kpi_1.33(2000-4999元事故_二级)
insert overwrite table  kpi_b_level
select ----'1.33' as kpi,
primary_classification,
second_level_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification,second_level_classification) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.33(2000-4999元事故_车龄)
insert overwrite table  kpi_agetype
select ----'1.33' as kpi,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code,age_type;

----kpi_1.33(2000-4999元事故_保内外)
insert overwrite table  kpi_bnbw
select ----'1.33' as kpi,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code,bn;

----kpi_1.33(2000-4999元事故_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.33' as kpi,
primary_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code,age_type,primary_classification;

----kpi_1.33(2000-4999元事故_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.33' as kpi,
primary_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code,bn,primary_classification;

----kpi_1.33(2000-4999元事故_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.33' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification,second_level_classification) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code,age_type,primary_classification,second_level_classification;

----kpi_1.33(2000-4999元事故_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.33' as kpi,
primary_classification,
second_level_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification,second_level_classification) s 
where sumamount>=2000 and sumamount<5000 
group by substr(order_date,1,7),asc_code,bn,primary_classification,second_level_classification;

----kpi_1.34(5000-9999元事故_total)
insert overwrite table  kpi_total
select ----'1.34' as kpi,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin
    ) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code;

----kpi_1.34(5000-9999元事故_一级)
insert overwrite table  kpi_a_level
select ----'1.34' as kpi,
primary_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code,primary_classification;

----kpi_1.34(5000-9999元事故_二级)
insert overwrite table  kpi_b_level
select ----'1.34' as kpi,
primary_classification,
second_level_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification,second_level_classification) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.34(5000-9999元事故_车龄)
insert overwrite table  kpi_agetype
select ----'1.34' as kpi,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code,age_type;

----kpi_1.34(5000-9999元事故_保内外)
insert overwrite table  kpi_bnbw
select ----'1.34' as kpi,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code,bn;

----kpi_1.34(5000-9999元事故_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.34' as kpi,
primary_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code,age_type,primary_classification;

----kpi_1.34(5000-9999元事故_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.34' as kpi,
primary_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code,bn,primary_classification;

----kpi_1.34(5000-9999元事故_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.34' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification,second_level_classification) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code,age_type,primary_classification,second_level_classification;

----kpi_1.34(5000-9999元事故_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.34' as kpi,
primary_classification,
second_level_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification,second_level_classification) s 
where sumamount>=5000 and sumamount<10000 
group by substr(order_date,1,7),asc_code,bn,primary_classification,second_level_classification;


----kpi_1.35(10000元以上事故_total)
insert overwrite table  kpi_total
select ----'1.35' as kpi,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin
    ) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code;

----kpi_1.35(10000元以上事故_一级)
insert overwrite table  kpi_a_level
select ----'1.35' as kpi,
primary_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code,primary_classification;

----kpi_1.35(10000元以上事故_二级)
insert overwrite table  kpi_b_level
select ----'1.35' as kpi,
primary_classification,
second_level_classification,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,primary_classification,second_level_classification) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.35(10000元以上事故_车龄)
insert overwrite table  kpi_agetype
select ----'1.35' as kpi,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code,age_type;

----kpi_1.35(10000元以上事故_保内外)
insert overwrite table  kpi_bnbw
select ----'1.35' as kpi,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code,bn;

----kpi_1.35(10000元以上事故_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.35' as kpi,
primary_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code,age_type,primary_classification;

----kpi_1.35(10000元以上事故_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.35' as kpi,
primary_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code,bn,primary_classification;

----kpi_1.35(10000元以上事故_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.35' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 age_type,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,age_type,primary_classification,second_level_classification) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code,age_type,primary_classification,second_level_classification;

----kpi_1.35(10000元以上事故_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.35' as kpi,
primary_classification,
second_level_classification,
bn,
substr(order_date,1,7) as mon,
count(*) as cnt,
asc_code
 from (
 select asc_code,
 primary_classification,
 second_level_classification,
 bn,
 tran_date(order_balance_date) as order_date,
 vin,
 sum(order_balance_amount) as sumamount  
 from label_order  
where MAINT_TYPE1='事故'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by asc_code,tran_date(order_balance_date),vin,bn,primary_classification,second_level_classification) s 
where sumamount>=10000 
group by substr(order_date,1,7),asc_code,bn,primary_classification,second_level_classification;


----kpi_1.36(事故台次占比_total)
insert overwrite table  kpi_total
select ----'1.36' as kpi,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_total 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_total 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon ;

----kpi_1.36(事故台次占比_一级)
insert overwrite table  kpi_a_level
select ----'1.36' as kpi,
 s.a_level,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_level 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_level 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level ;

----kpi_1.36(事故台次占比_二级)
insert overwrite table  kpi_b_level
select ----'1.36' as kpi,
 s.a_level,
 s.b_level,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_level 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_level 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level 
  and s.b_level=t.b_level;

----kpi_1.36(事故台次占比_车龄)
insert overwrite table  kpi_agetype
select ----'1.36' as kpi,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_agetype 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.age_type=t.age_type ;

----kpi_1.36(事故台次占比_保内外)
insert overwrite table  kpi_bnbw
select ----'1.36' as kpi,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_bnbw 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.bnbw=t.bnbw ;

----kpi_1.36(事故台次占比_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.36' as kpi,
 s.a_level,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_agetype 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.age_type=t.age_type ;

----kpi_1.36(事故台次占比_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.36' as kpi,
 s.a_level,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_bnbw 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.bnbw=t.bnbw ;

----kpi_1.36(事故台次占比_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.36' as kpi,
 s.a_level,
 s.b_level,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_agetype 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.b_level=t.b_level
  and s.age_type=t.age_type ;

----kpi_1.36(事故台次占比_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.36' as kpi,
 s.a_level,
 s.b_level,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_bnbw 
where kpi='kpi_1_3'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.b_level=t.b_level
  and s.bnbw=t.bnbw ;
  
  
----kpi_1.4(索赔台次_total)
insert overwrite table  kpi_total
select ----'1.4' as kpi,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code;

----kpi_1.4(索赔台次_一级)
insert overwrite table  kpi_a_level
select ----'1.4' as kpi,
primary_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification;

----kpi_1.4(索赔台次_二级)
insert overwrite table  kpi_b_level
select ----'1.4' as kpi,
primary_classification,
second_level_classification,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification;

----kpi_1.4(索赔台次_车龄)
insert overwrite table  kpi_agetype
select ----'1.4' as kpi,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,age_type;

----kpi_1.4(索赔台次_保内外)
insert overwrite table  kpi_bnbw
select ----'1.4' as kpi,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,bn;

----kpi_1.4(索赔台次_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.4' as kpi,
primary_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,age_type;

----kpi_1.4(索赔台次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.4' as kpi,
primary_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,bn;

----kpi_1.4(索赔台次_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.4' as kpi,
primary_classification,
second_level_classification,
age_type,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,age_type;

----kpi_1.4(索赔台次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.4' as kpi,
primary_classification,
second_level_classification,
bn,
substr(tran_date(order_balance_date),1,7) as mon,
count(distinct vin,tran_date(order_balance_date)) as cnt,
asc_code
 from label_order  
where claim='1'
and substr(tran_date(order_balance_date),1,7)>='${begin_date}'
and substr(tran_date(order_balance_date),1,7)<='${end_date}'
group by substr(tran_date(order_balance_date),1,7),asc_code,primary_classification,second_level_classification,bn;


----kpi_1.41(索赔台次占比_total)
insert overwrite table  kpi_total
select ----'1.41' as kpi,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_total 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_total 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon ;

----kpi_1.41(索赔台次占比_一级)
insert overwrite table  kpi_a_level
select ----'1.41' as kpi,
 s.a_level,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_level 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_level 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level ;

----kpi_1.41(索赔台次占比_二级)
insert overwrite table  kpi_b_level
select ----'1.41' as kpi,
 s.a_level,
 s.b_level,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_level 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_level 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level 
  and s.b_level=t.b_level;

----kpi_1.41(索赔台次占比_车龄)
insert overwrite table  kpi_agetype
select ----'1.41' as kpi,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_agetype 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.age_type=t.age_type ;

----kpi_1.41(索赔台次占比_保内外)
insert overwrite table  kpi_bnbw
select ----'1.41' as kpi,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_bnbw 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.bnbw=t.bnbw ;

----kpi_1.41(索赔台次占比_一级_车龄)
insert overwrite table  kpi_a_agetype
select ----'1.41' as kpi,
 s.a_level,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_agetype 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.age_type=t.age_type ;

----kpi_1.41(索赔台次占比_一级_保内外)
insert overwrite table  kpi_a_bnbw
select ----'1.41' as kpi,
 s.a_level,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_a_bnbw 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_a_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.bnbw=t.bnbw ;

----kpi_1.41(索赔台次占比_二级_车龄)
insert overwrite table  kpi_b_agetype
select ----'1.41' as kpi,
 s.a_level,
 s.b_level,
 s.age_type,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_agetype 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_agetype 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.b_level=t.b_level
  and s.age_type=t.age_type ;

----kpi_1.41(索赔台次占比_二级_保内外)
insert overwrite table  kpi_b_bnbw
select ----'1.41' as kpi,
 s.a_level,
 s.b_level,
 s.bnbw,
 s.mon,
 s.num/t.num as num,
 s.asc_code
from (
select * from kpi_b_bnbw 
where kpi='kpi_1_4'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) s,(
select * from kpi_b_bnbw 
where kpi='kpi_1'
  and mon>='${begin_date}'
  and mon<='${end_date}'
 ) t 
where s.asc_code=t.asc_code
  and s.mon=t.mon 
  and s.a_level=t.a_level
  and s.b_level=t.b_level
  and s.bnbw=t.bnbw ;
  
----kpi_2(进站频次_total)
insert overwrite table  kpi_total
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code;
  

----kpi_2(进站频次_一级)
insert overwrite table  kpi_a_level
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification;

----kpi_2(进站频次_二级)
insert overwrite table  kpi_b_level
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_2(进站频次_车龄)
insert overwrite table  kpi_agetype
select case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2(进站频次_保内外)
insert overwrite table  kpi_bnbw
select case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end;

----kpi_2(进站频次_一级_车龄)
insert overwrite table  kpi_a_agetype
select primary_classification,
 case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2(进站频次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select primary_classification,
 case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;

----kpi_2(进站频次_二级_车龄)
insert overwrite table  kpi_b_agetype
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2(进站频次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;
  
  
----kpi_2.1(五年基盘客户数_total)
insert overwrite table  kpi_total
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code;
  

----kpi_2.1(五年基盘客户数_一级)
insert overwrite table  kpi_a_level
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification;

----kpi_2.1(五年基盘客户数_二级)
insert overwrite table  kpi_b_level
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_2.1(五年基盘客户数_车龄)
insert overwrite table  kpi_agetype
select case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.1(五年基盘客户数_保内外)
insert overwrite table  kpi_bnbw
select case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;

----kpi_2.1(五年基盘客户数_一级_车龄)
insert overwrite table  kpi_a_agetype
select primary_classification,
 case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.1(五年基盘客户数_一级_保内外)
insert overwrite table  kpi_a_bnbw
select primary_classification,
 case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;

----kpi_2.1(五年基盘客户数_二级_车龄)
insert overwrite table  kpi_b_agetype
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.1(五年基盘客户数_二级_保内外)
insert overwrite table  kpi_b_bnbw
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;
  
----kpi_2.2(一年有效基盘_total)
insert overwrite table  kpi_total
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code;
  

----kpi_2.2(一年有效基盘_一级)
insert overwrite table  kpi_a_level
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification;

----kpi_2.2(一年有效基盘_二级)
insert overwrite table  kpi_b_level
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_2.2(一年有效基盘_车龄)
insert overwrite table  kpi_agetype
select case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.2(一年有效基盘_保内外)
insert overwrite table  kpi_bnbw
select case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;

----kpi_2.2(一年有效基盘_一级_车龄)
insert overwrite table  kpi_a_agetype
select primary_classification,
 case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.2(一年有效基盘_一级_保内外)
insert overwrite table  kpi_a_bnbw
select primary_classification,
 case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;

----kpi_2.2(一年有效基盘_二级_车龄)
insert overwrite table  kpi_b_agetype
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.2(一年有效基盘_二级_保内外)
insert overwrite table  kpi_b_bnbw
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;
  

----kpi_2.3(年进站保养频次_total)
insert overwrite table  kpi_total
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code;
  

----kpi_2.3(年进站保养频次_一级)
insert overwrite table  kpi_a_level
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification;

----kpi_2.3(年进站保养频次_二级)
insert overwrite table  kpi_b_level
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_2.3(年进站保养频次_车龄)
insert overwrite table  kpi_agetype
select case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.3(年进站保养频次_保内外)
insert overwrite table  kpi_bnbw
select case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;

----kpi_2.3(年进站保养频次_一级_车龄)
insert overwrite table  kpi_a_agetype
select primary_classification,
 case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.3(年进站保养频次_一级_保内外)
insert overwrite table  kpi_a_bnbw
select primary_classification,
 case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;

----kpi_2.3(年进站保养频次_二级_车龄)
insert overwrite table  kpi_b_agetype
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.3(年进站保养频次_二级_保内外)
insert overwrite table  kpi_b_bnbw
select primary_classification,
 second_level_classification,
 case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin,tran_date(s.order_balance_date))/count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
    when s.outdate<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
    when s.outdate>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
    else '' end ;

  
  
----kpi_2.4(五年新车销售数_total)
insert overwrite table  kpi_total
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code;
  

----kpi_2.4(五年新车销售数_一级)
insert overwrite table  kpi_a_level
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification;

----kpi_2.4(五年新车销售数_二级)
insert overwrite table  kpi_b_level
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_2.4(五年新车销售数_车龄)
insert overwrite table  kpi_agetype
select case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and year(t.mon_label)*12+month(t.mon_label)-year(tran_date(s.in voice_date))*12-month(tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.4(五年新车销售数_保内外)
insert overwrite table  kpi_bnbw
select case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end ;

----kpi_2.4(五年新车销售数_一级_车龄)
insert overwrite table  kpi_a_agetype
select primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.4(五年新车销售数_一级_保内外)
insert overwrite table  kpi_a_bnbw
select primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end ;

----kpi_2.4(五年新车销售数_二级_车龄)
insert overwrite table  kpi_b_agetype
select primary_classification,
 second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.4(五年新车销售数_二级_保内外)
insert overwrite table  kpi_b_bnbw
select primary_classification,
 second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-59),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end ;


----kpi_2.41(五年年均新车销售数_total)
insert overwrite table  kpi_total
select mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_total s ,
(
select min(mon) as minmon,asc_code from kpi_total
where kpi='kpi_2_4'
group by asc_code
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_一级)
insert overwrite table  kpi_a_level
select a_level,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_a_level s ,
(
select min(mon) as minmon,asc_code,a_level from kpi_a_level
where kpi='kpi_2_4'
group by asc_code,a_level
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_二级)
insert overwrite table  kpi_b_level
select a_level,
b_level,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.b_level,s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_b_level s ,
(
select min(mon) as minmon,asc_code,a_level,b_level from kpi_b_level
where kpi='kpi_2_4'
group by asc_code,a_level,b_level
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.b_level=t.b_level
and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_车龄)
insert overwrite table  kpi_agetype
select age_type,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.age_type,s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_agetype s ,
(
select min(mon) as minmon,asc_code,age_type from kpi_agetype
where kpi='kpi_2_4'
group by asc_code,age_type
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.age_type=t.age_type
and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_保内外)
insert overwrite table  kpi_bnbw
select bn,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.bn,s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_bnbw s ,
(
select min(mon) as minmon,asc_code,bn from kpi_bnbw
where kpi='kpi_2_4'
group by asc_code,bn
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.bn=t.bn
and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_一级_车龄)
insert overwrite table  kpi_a_agetype
select a_level,
age_type,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.age_type,s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_a_agetype s ,
(
select min(mon) as minmon,asc_code,a_level,age_type from kpi_a_agetype
where kpi='kpi_2_4'
group by asc_code,a_level,age_type
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.age_type=t.age_type
and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
) s ;


----kpi_2.41(五年年均新车销售数_一级_保内外)
insert overwrite table  kpi_a_bnbw
select a_level,
bn,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.bn,s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_a_bnbw s ,
(
select min(mon) as minmon,asc_code,a_level,bn from kpi_a_bnbw
where kpi='kpi_2_4'
group by asc_code,a_level,bn
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.bn=t.bn
and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
) s ;

----kpi_2.41(五年年均新车销售数_二级_车龄)
insert overwrite table  kpi_b_agetype
select a_level,
b_level,
age_type,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.b_level,s.age_type,s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_b_agetype s ,
(
select min(mon) as minmon,asc_code,a_level,b_level,age_type from kpi_b_agetype
where kpi='kpi_2_4'
group by asc_code,a_level,age_type,b_level
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.age_type=t.age_type
and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
and s.b_level=t.b_level
) s ;

----kpi_2.41(五年年均新车销售数_二级_保内外)
insert overwrite table  kpi_b_bnbw
select a_level,
b_level,
bn,
mon,
num*12/(case when yc<=60 then yc else 60 end) as num,
asc_code
from (
select s.a_level,s.b_level,s.bn,s.mon,
year(concat(s.mon,'-01'))*12+month(concat(s.mon,'-01'))-year(concat(t.minmon,'-01'))*12-month(concat(t.minmon,'-01'))+1 as yc,
s.num,
s.asc_code
from kpi_b_bnbw s ,
(
select min(mon) as minmon,asc_code,a_level,b_level,bn from kpi_b_bnbw
where kpi='kpi_2_4'
group by asc_code,a_level,bn,b_level
) t where s.asc_code=t.asc_code and s.kpi='kpi_2_4' and s.a_level=t.a_level and s.bn=t.bn
and s.b_level=t.b_level
and s.mon>='${begin_date}'
  and s.mon<='${end_date}'
) s ;



----kpi_2.42(本年新车销售数_total)
insert overwrite table  kpi_total
select substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code;
  

----kpi_2.42(本年新车销售数_一级)
insert overwrite table  kpi_a_level
select primary_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification;

----kpi_2.42(本年新车销售数_二级)
insert overwrite table  kpi_b_level
select primary_classification,
 second_level_classification,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_2.42(本年新车销售数_车龄)
insert overwrite table  kpi_agetype
select case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and year(t.mon_label)*12+month(t.mon_label)-year(tran_date(s.in voice_date))*12-month(tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.42(本年新车销售数_保内外)
insert overwrite table  kpi_bnbw
select case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end ;

----kpi_2.42(本年新车销售数_一级_车龄)
insert overwrite table  kpi_a_agetype
select primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.42(本年新车销售数_一级_保内外)
insert overwrite table  kpi_a_bnbw
select primary_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end ;

----kpi_2.42(本年新车销售数_二级_车龄)
insert overwrite table  kpi_b_agetype
select primary_classification,
 second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as agetype,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end ;

----kpi_2.42(本年新车销售数_二级_保内外)
insert overwrite table  kpi_b_bnbw
select primary_classification,
 second_level_classification,
 case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end as bn,
 substr(t.mon_label,1,7) as mon,
 count(distinct s.vin) as num,
 s.asc_code
 from date_label t,label_doss s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>'' and s.asc_code<>''
  group by substr(t.mon_label,1,7),s.asc_code,primary_classification,second_level_classification,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
    when tran_date(s.invoice_date)<'2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
    when tran_date(s.invoice_date)>='2013-10-01' 
    and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
    else '' end ;
	
	
----kpi_3(客户忠诚率_total)
insert overwrite table  kpi_total
 select s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.mon,count(*) as cnt from ( 
  select s.asc_code,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,
  s.vin,
  substr(t.mon_label,1,7)
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon
  ) s ,
  (select * from kpi_total where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon;

----kpi_3(客户忠诚率_一级)
insert overwrite table  kpi_a_level
select s.primary_classification,
 s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.primary_classification,s.mon,count(*) as cnt from 
 ( 
  select s.asc_code,
  s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,
  s.vin,
  substr(t.mon_label,1,7),
  s.primary_classification
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon,primary_classification
  ) s ,
  (select * from kpi_a_level where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon and s.primary_classification=t.a_level;

----kpi_3(客户忠诚率_二级)
insert overwrite table  kpi_b_level
select s.primary_classification,
 s.second_level_classification,
 s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.primary_classification,s.second_level_classification,s.mon,count(*) as cnt from 
 ( 
  select s.asc_code,
  s.primary_classification,
  s.second_level_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,
  s.vin,
  substr(t.mon_label,1,7),
  s.primary_classification,
  s.second_level_classification
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon,primary_classification,s.second_level_classification
  ) s ,
  (select * from kpi_b_level where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon and s.primary_classification=t.a_level
  and s.second_level_classification=t.b_level
  ;

----kpi_3(客户忠诚率_车龄)
insert overwrite table  kpi_agetype
select s.agetype,
 s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.agetype,s.mon,count(*) as cnt from 
 ( 
  select s.asc_code,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,
  s.vin,
  substr(t.mon_label,1,7),
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon,agetype
  ) s ,
  (select * from kpi_agetype where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon and s.agetype=t.age_type;

----kpi_3(客户忠诚率_保内外)
insert overwrite table  kpi_bnbw
select s.bn,
 s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.bn,s.mon,count(*) as cnt from 
 ( 
  select s.asc_code,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,
  s.vin,
  substr(t.mon_label,1,7),
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end 
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon,bn
  ) s ,
  (select * from kpi_bnbw where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bnbw;

----kpi_3(客户忠诚率_一级_车龄)
insert overwrite table  kpi_a_agetype
select s.primary_classification,s.agetype,
 s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.primary_classification,s.agetype,s.mon,count(*) as cnt from 
 ( 
  select s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,primary_classification,
  s.vin,
  substr(t.mon_label,1,7),
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon,agetype,primary_classification
  ) s ,
  (select * from kpi_a_agetype where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon and s.agetype=t.age_type and s.primary_classification=t.a_level;

----kpi_3(客户忠诚率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select s.primary_classification,s.bn,
 s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.primary_classification,s.bn,s.mon,count(*) as cnt from 
 ( 
  select s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,primary_classification,
  s.vin,
  substr(t.mon_label,1,7),
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon,bn,primary_classification
  ) s ,
  (select * from kpi_a_bnbw where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bnbw and s.primary_classification=t.a_level;

----kpi_3(客户忠诚率_二级_车龄)
insert overwrite table  kpi_b_agetype
select s.primary_classification,s.second_level_classification,s.agetype,
 s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.primary_classification,s.second_level_classification,
 s.agetype,s.mon,count(*) as cnt from 
 ( 
  select s.asc_code,primary_classification,s.second_level_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as agetype,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,primary_classification,s.second_level_classification
  s.vin,
  substr(t.mon_label,1,7),
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon,agetype,primary_classification,s.second_level_classification
  ) s ,
  (select * from kpi_b_agetype where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon and s.agetype=t.age_type and s.primary_classification=t.a_level
  and s.second_level_classification=t.b_level
  ;

----kpi_3(客户忠诚率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select s.primary_classification,s.second_level_classification,s.bn,
 s.mon,
 s.cnt/t.num as num,
 s.asc_code
 from (
 select s.asc_code,s.primary_classification,s.second_level_classification,
 s.bn,s.mon,count(*) as cnt from 
 ( 
  select s.asc_code,primary_classification,s.second_level_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon,
  count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end) 
from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  group by s.asc_code,primary_classification,s.second_level_classification
  s.vin,
  substr(t.mon_label,1,7),
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end 
  having count(case when s.MAINT_TYPE1='保养' and  s.order_balance_amount>0 then vin else null end)>=2
  ) s group by s.asc_code,s.mon,bn,primary_classification,s.second_level_classification
  ) s ,
  (select * from kpi_b_bnbw where kpi='kpi_2_2') t
  where s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bnbw and s.primary_classification=t.a_level
  and s.second_level_classification=t.b_level
  ;
  
  
----kpi_3.1(首保进站率_total)
insert overwrite table  kpi_total
  select s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon
  group by s.mon,s.asc_code;

----kpi_3.1(首保进站率_一级)
insert overwrite table  kpi_a_level
  select s.primary_classification,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.primary_classification;

----kpi_3.1(首保进站率_二级)
insert overwrite table  kpi_b_level
select s.primary_classification,s.second_level_classification,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,s.primary_classification,s.second_level_classification
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,s.primary_classification,s.second_level_classification
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.primary_classification,s.second_level_classification;

----kpi_3.1(首保进站率_车龄)
insert overwrite table  kpi_agetype
select s.age_type,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.age_type=t.age_type
  group by s.mon,s.asc_code,s.age_type;

----kpi_3.1(首保进站率_保内外)
insert overwrite table  kpi_bnbw
select s.bn,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.bn=t.bn
  group by s.mon,s.asc_code,s.bn;

----kpi_3.1(首保进站率_一级_车龄)
insert overwrite table  kpi_a_agetype
select s.primary_classification,s.age_type,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as age_type,
	s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon ,
  s.primary_classification
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.age_type=t.age_type and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.age_type,s.primary_classification;

----kpi_3.1(首保进站率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select s.primary_classification,s.bn,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.primary_classification,
    s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.primary_classification,
    s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.bn=t.bn and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.bn,s.primary_classification;

----kpi_3.1(首保进站率_二级_车龄)
insert overwrite table  kpi_b_agetype
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as age_type,
	s.primary_classification,
	s.second_level_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon ,
  s.primary_classification,
  s.second_level_classification
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.age_type=t.age_type and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.age_type,s.primary_classification,s.second_level_classification;

----kpi_3.1(首保进站率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select s.primary_classification,second_level_classification,s.bn,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.primary_classification,s.second_level_classification,
    s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.primary_classification,s.second_level_classification,
    s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.bn=t.bn and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.bn,s.primary_classification,s.second_level_classification;
  
  
----kpi_3.12(本店销售车辆首保回站率_total)
insert overwrite table  kpi_total
  select s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon
  group by s.mon,s.asc_code;

----kpi_3.12(本店销售车辆首保回站率_一级)
insert overwrite table  kpi_a_level
  select s.primary_classification,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.primary_classification;

----kpi_3.12(本店销售车辆首保回站率_二级)
insert overwrite table  kpi_b_level
select s.primary_classification,s.second_level_classification,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,s.primary_classification,s.second_level_classification
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,s.primary_classification,s.second_level_classification
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.primary_classification,s.second_level_classification;

----kpi_3.12(本店销售车辆首保回站率_车龄)
insert overwrite table  kpi_agetype
select s.age_type,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.age_type=t.age_type
  group by s.mon,s.asc_code,s.age_type;

----kpi_3.12(本店销售车辆首保回站率_保内外)
insert overwrite table  kpi_bnbw
select s.bn,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.bn=t.bn
  group by s.mon,s.asc_code,s.bn;

----kpi_3.12(本店销售车辆首保回站率_一级_车龄)
insert overwrite table  kpi_a_agetype
select s.primary_classification,s.age_type,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as age_type,
	s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon ,
  s.primary_classification
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.age_type=t.age_type and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.age_type,s.primary_classification;

----kpi_3.12(本店销售车辆首保回站率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select s.primary_classification,s.bn,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.primary_classification,
    s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.primary_classification,
    s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.bn=t.bn and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.bn,s.primary_classification;

----kpi_3.12(本店销售车辆首保回站率_二级_车龄)
insert overwrite table  kpi_b_agetype
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=12
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=24
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=36
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.invoice_date))>=48
    and mon_diff(t.mon_label,tran_date(s.invoice_date))<=59 then '4-5年'
    else '5+年' end as age_type,
	s.primary_classification,
	s.second_level_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon ,
  s.primary_classification,
  s.second_level_classification
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.age_type=t.age_type and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.age_type,s.primary_classification,s.second_level_classification;

----kpi_3.12(本店销售车辆首保回站率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select s.primary_classification,second_level_classification,s.bn,s.mon,
  sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select s.primary_classification,s.second_level_classification,
    s.asc_code,case when tran_date(s.invoice_date)='未知' then '未知'
    when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=23 then '保内'
	when tran_date(s.invoice_date)<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>23 then '保外'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))<=35 then '保内'
	when tran_date(s.invoice_date)>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.invoice_date))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_doss s
  where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.report_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.report_date),1,7)<=substr(t.mon_label,1,7)
  and s.primary_classification<>''
  ) s left join(  
  select distinct s.primary_classification,s.second_level_classification,
    s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon 
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-17),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
  ) t on s.asc_code=t.asc_code and s.vin=t.vin and s.mon=t.mon 
  and s.bn=t.bn and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.bn,s.primary_classification,s.second_level_classification;
  

  
----kpi_3.2(首次付费保养进站率_total)
insert overwrite table  kpi_total
select s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin
  group by s.mon,s.asc_code ;
  
  
  

----kpi_3.2(首次付费保养进站率_一级)
insert overwrite table  kpi_a_level
  select s.primary_classification,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,s.primary_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin 
  and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.primary_classification;

----kpi_3.2(首次付费保养进站率_二级)
insert overwrite table  kpi_b_level
 select s.primary_classification,s.second_level_classification,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,s.primary_classification,s.second_level_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,s.primary_classification,s.second_level_classification,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin 
  and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.primary_classification,s.second_level_classification;

----kpi_3.2(首次付费保养进站率_车龄)
insert overwrite table  kpi_agetype
select s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin 
  and s.age_type=t.age_type
  group by s.mon,s.asc_code,s.age_type;

----kpi_3.2(首次付费保养进站率_保内外)
insert overwrite table  kpi_bnbw
select s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin 
  and s.bn=t.bn
  group by s.mon,s.asc_code,s.bn;

----kpi_3.2(首次付费保养进站率_一级_车龄)
insert overwrite table  kpi_a_agetype
select s.primary_classification,s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,s.primary_classification,
    case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,s.primary_classification,
    case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin 
  and s.age_type=t.age_type and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.age_type,primary_classification;

----kpi_3.2(首次付费保养进站率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select s.primary_classification,s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,s.primary_classification,
    case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,s.primary_classification,
    case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin 
  and s.bn=t.bn and s.primary_classification=t.primary_classification
  group by s.mon,s.asc_code,s.bn,s.primary_classification;

----kpi_3.2(首次付费保养进站率_二级_车龄)
insert overwrite table  kpi_b_agetype
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,s.primary_classification,s.second_level_classification,
    case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,s.primary_classification,s.second_level_classification,
    case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin 
  and s.age_type=t.age_type and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.age_type,primary_classification;

----kpi_3.2(首次付费保养进站率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
sum(case when t.vin is not null then 1 else 0 end)/count(s.vin) as num,
s.asc_code 
 from (
select distinct s.asc_code,s.primary_classification,s.second_level_classification,
    case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon
 from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-7),1,7)
  and s.MAINT_TYPE1<>'删除'
  and first_maintnance=1
) s left join (
select distinct s.asc_code,s.primary_classification,s.second_level_classification,
    case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  s.vin,
  substr(t.mon_label,1,7) as mon
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-6),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1='保养'
  and s.order_balance_amount>0
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.vin=t.vin 
  and s.bn=t.bn and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  group by s.mon,s.asc_code,s.bn,s.primary_classification,s.second_level_classification;
  
  
  
----kpi_3.4(养护品着装率_total)
insert overwrite table  kpi_total
 select  
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
  
  
  

----kpi_3.4(养护品着装率_一级)
insert overwrite table  kpi_a_level
   select  primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification;

----kpi_3.4(养护品着装率_二级)
insert overwrite table  kpi_b_level
   select  primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_3.4(养护品着装率_车龄)
insert overwrite table  kpi_agetype
 select  age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type;

----kpi_3.4(养护品着装率_保内外)
insert overwrite table  kpi_bnbw
select  bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn;

----kpi_3.4(养护品着装率_一级_车龄)
insert overwrite table  kpi_a_agetype
select  primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification;

----kpi_3.4(养护品着装率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select  primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification;

----kpi_3.4(养护品着装率_二级_车龄)
insert overwrite table  kpi_b_agetype
select  primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification;

----kpi_3.4(养护品着装率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select  primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,maintnance x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification;
  
  
  
----kpi_3.5(高流失件渗透率_total)
insert overwrite table  kpi_total
 select  
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
  
  
  

----kpi_3.5(高流失件渗透率_一级)
insert overwrite table  kpi_a_level
   select  primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification;

----kpi_3.5(高流失件渗透率_二级)
insert overwrite table  kpi_b_level
   select  primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_3.5(高流失件渗透率_车龄)
insert overwrite table  kpi_agetype
 select  age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type;

----kpi_3.5(高流失件渗透率_保内外)
insert overwrite table  kpi_bnbw
select  bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn;

----kpi_3.5(高流失件渗透率_一级_车龄)
insert overwrite table  kpi_a_agetype
select  primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification;

----kpi_3.5(高流失件渗透率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select  primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification;

----kpi_3.5(高流失件渗透率_二级_车龄)
insert overwrite table  kpi_b_agetype
select  primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification;

----kpi_3.5(高流失件渗透率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select  primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num 
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification;
  
  
  
----kpi_3.51(轮胎_total)
insert overwrite table  kpi_total
 select  
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
  
  
  

----kpi_3.51(轮胎_一级)
insert overwrite table  kpi_a_level
   select  primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification;

----kpi_3.51(轮胎_二级)
insert overwrite table  kpi_b_level
   select  primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_3.51(轮胎_车龄)
insert overwrite table  kpi_agetype
 select  age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type;

----kpi_3.51(轮胎_保内外)
insert overwrite table  kpi_bnbw
select  bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn;

----kpi_3.51(轮胎_一级_车龄)
insert overwrite table  kpi_a_agetype
select  primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification;

----kpi_3.51(轮胎_一级_保内外)
insert overwrite table  kpi_a_bnbw
select  primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification;

----kpi_3.51(轮胎_二级_车龄)
insert overwrite table  kpi_b_agetype
select  primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification;

----kpi_3.51(轮胎_二级_保内外)
insert overwrite table  kpi_b_bnbw
select  primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='LunT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification;


  
 ----kpi_3.52(蓄电池_total)
insert overwrite table  kpi_total
 select  
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
  
  
  

----kpi_3.52(蓄电池_一级)
insert overwrite table  kpi_a_level
   select  primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification;

----kpi_3.52(蓄电池_二级)
insert overwrite table  kpi_b_level
   select  primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_3.52(蓄电池_车龄)
insert overwrite table  kpi_agetype
 select  age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type;

----kpi_3.52(蓄电池_保内外)
insert overwrite table  kpi_bnbw
select  bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn;

----kpi_3.52(蓄电池_一级_车龄)
insert overwrite table  kpi_a_agetype
select  primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification;

----kpi_3.52(蓄电池_一级_保内外)
insert overwrite table  kpi_a_bnbw
select  primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification;

----kpi_3.52(蓄电池_二级_车龄)
insert overwrite table  kpi_b_agetype
select  primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification;

----kpi_3.52(蓄电池_二级_保内外)
insert overwrite table  kpi_b_bnbw
select  primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='DianC'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification;
  
  
  
----kpi_3.53(轮胎+蓄电池_total)
insert overwrite table  kpi_total
 select  
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
  
  
  

----kpi_3.53(轮胎+蓄电池_一级)
insert overwrite table  kpi_a_level
   select  primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification;

----kpi_3.53(轮胎+蓄电池_二级)
insert overwrite table  kpi_b_level
   select  primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_3.53(轮胎+蓄电池_车龄)
insert overwrite table  kpi_agetype
 select  age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type;

----kpi_3.53(轮胎+蓄电池_保内外)
insert overwrite table  kpi_bnbw
select  bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn;

----kpi_3.53(轮胎+蓄电池_一级_车龄)
insert overwrite table  kpi_a_agetype
select  primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification;

----kpi_3.53(轮胎+蓄电池_一级_保内外)
insert overwrite table  kpi_a_bnbw
select  primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification;

----kpi_3.53(轮胎+蓄电池_二级_车龄)
insert overwrite table  kpi_b_agetype
select  primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification;

----kpi_3.53(轮胎+蓄电池_二级_保内外)
insert overwrite table  kpi_b_bnbw
select  primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type in('DianC','LunT')
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification;
  
  

----kpi_3.54(其他高流失件_total)
insert overwrite table  kpi_total
 select  
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code;
  
  
  

----kpi_3.54(其他高流失件_一级)
insert overwrite table  kpi_a_level
   select  primary_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification;

----kpi_3.54(其他高流失件_二级)
insert overwrite table  kpi_b_level
   select  primary_classification,second_level_classification,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,primary_classification,second_level_classification;

----kpi_3.54(其他高流失件_车龄)
insert overwrite table  kpi_agetype
 select  age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type;

----kpi_3.54(其他高流失件_保内外)
insert overwrite table  kpi_bnbw
select  bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn;

----kpi_3.54(其他高流失件_一级_车龄)
insert overwrite table  kpi_a_agetype
select  primary_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification;

----kpi_3.54(其他高流失件_一级_保内外)
insert overwrite table  kpi_a_bnbw
select  primary_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification;

----kpi_3.54(其他高流失件_二级_车龄)
insert overwrite table  kpi_b_agetype
select  primary_classification,second_level_classification, age_type,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,age_type,primary_classification,second_level_classification;

----kpi_3.54(其他高流失件_二级_保内外)
insert overwrite table  kpi_b_bnbw
select  primary_classification,second_level_classification, bn,
 substr(tran_date(s.order_balance_date),1,7) as mon,
 count(distinct case when t.asc_code is not null then s.vin else null end)/count(distinct s.vin) as num,
 s.asc_code
 from label_order s 
 left join (
  select distinct t.asc_code,t.order_number from part t ,high_flow_parts x
 where  t.part_number=x.part_num  and x.type='QiT'
   ) t 
  on  s.order_number=t.order_number
  and s.asc_code=t.asc_code
  where substr(tran_date(s.order_balance_date),1,7)>='${begin_date}'
  and substr(tran_date(s.order_balance_date),1,7)<='${end_date}'
  and s.MAINT_TYPE1<>'删除'
  group by substr(tran_date(s.order_balance_date),1,7),s.asc_code,bn,primary_classification,second_level_classification;
  
  
----kpi_3.6(客户流失率_total)
insert overwrite table  kpi_total
 select s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_total where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_total where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code;
  

----kpi_3.6(客户流失率_一级)
insert overwrite table  kpi_a_level
   select 
   s.a_level,
   s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_a_level where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_a_level where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.a_level=t.a_level;

----kpi_3.6(客户流失率_二级)
insert overwrite table  kpi_b_level
   select 
   s.a_level,
   s.b_level,
   s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_b_level where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_b_level where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.a_level=t.a_level and s.b_level=t.b_level;

----kpi_3.6(客户流失率_车龄)
insert overwrite table  kpi_agetype
  select 
   s.age_type,
   s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_agetype where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_agetype where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.age_type=t.age_type;

----kpi_3.6(客户流失率_保内外)
insert overwrite table  kpi_bnbw
select 
   s.bnbw,
   s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_bnbw where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_bnbw where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.bnbw=t.bnbw;

----kpi_3.6(客户流失率_一级_车龄)
insert overwrite table  kpi_a_agetype
select
   s.a_level, 
   s.age_type,
   s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_a_agetype where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_a_agetype where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.age_type=t.age_type and s.a_level=t.a_level;

----kpi_3.6(客户流失率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select
   s.a_level, 
   s.bnbw,
   s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_a_bnbw where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_a_bnbw where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.bnbw=t.bnbw and s.a_level=t.a_level;

----kpi_3.6(客户流失率_二级_车龄)
insert overwrite table  kpi_b_agetype
select
   s.a_level,
   s.b_level,
   s.age_type,
   s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_b_agetype where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_b_agetype where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.age_type=t.age_type and s.a_level=t.a_level and s.b_level=t.b_level;

----kpi_3.6(客户流失率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select
   s.a_level,
   s.b_level,
   s.bnbw,
   s.mon,
 (s.num-t.num)/s.num as num,
  s.asc_code
 from 
 (select * from kpi_b_bnbw where kpi='kpi_2_1') s 
 left join 
 (select * from kpi_b_bnbw where kpi='kpi_2_2') t
 on s.mon=t.mon and s.asc_code=t.asc_code and s.bnbw=t.bnbw and s.a_level=t.a_level and s.b_level=t.b_level;
  

  
----kpi_3.61(一年客户流失率_total)
insert overwrite table  kpi_total
  select s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon ;
  
  

----kpi_3.61(一年客户流失率_一级)
insert overwrite table  kpi_a_level
 select s.primary_classification,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,s.primary_classification,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,s.primary_classification,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.primary_classification=t.primary_classification;
  
  
----kpi_3.61(一年客户流失率_二级)
insert overwrite table  kpi_b_level
 select s.primary_classification,second_level_classification,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,s.primary_classification,second_level_classification,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,s.primary_classification,second_level_classification,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  ;
  
  

----kpi_3.61(一年客户流失率_车龄)
insert overwrite table  kpi_agetype
  select s.age_type,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.age_type=t.age_type;

----kpi_3.61(一年客户流失率_保内外)
insert overwrite table  kpi_bnbw
select s.bn,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bn;

----kpi_3.61(一年客户流失率_一级_车龄)
insert overwrite table  kpi_a_agetype
select s.primary_classification,s.age_type,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.age_type=t.age_type 
  and s.primary_classification=t.primary_classification;

----kpi_3.61(一年客户流失率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select s.primary_classification,s.bn,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bn
  and s.primary_classification=t.primary_classification;

----kpi_3.61(一年客户流失率_二级_车龄)
insert overwrite table  kpi_b_agetype
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.age_type=t.age_type 
  and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification;

----kpi_3.61(一年客户流失率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-12),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-11),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bn
  and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification;
  
  
----kpi_3.62(濒临流失客户率_total)
insert overwrite table  kpi_total
  select s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon ;
  
  

----kpi_3.62(濒临流失客户率_一级)
insert overwrite table  kpi_a_level
 select s.primary_classification,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,s.primary_classification,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,s.primary_classification,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.primary_classification=t.primary_classification;
  
  
----kpi_3.62(濒临流失客户率_二级)
insert overwrite table  kpi_b_level
 select s.primary_classification,second_level_classification,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,s.primary_classification,second_level_classification,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,s.primary_classification,second_level_classification,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification
  ;
  
  

----kpi_3.62(濒临流失客户率_车龄)
insert overwrite table  kpi_agetype
  select s.age_type,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.age_type=t.age_type;

----kpi_3.62(濒临流失客户率_保内外)
insert overwrite table  kpi_bnbw
select s.bn,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bn;

----kpi_3.62(濒临流失客户率_一级_车龄)
insert overwrite table  kpi_a_agetype
select s.primary_classification,s.age_type,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.age_type=t.age_type 
  and s.primary_classification=t.primary_classification;

----kpi_3.62(濒临流失客户率_一级_保内外)
insert overwrite table  kpi_a_bnbw
select s.primary_classification,s.bn,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,primary_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bn
  and s.primary_classification=t.primary_classification;

----kpi_3.62(濒临流失客户率_二级_车龄)
insert overwrite table  kpi_b_agetype
select s.primary_classification,s.second_level_classification,s.age_type,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
    when mon_diff(t.mon_label,tran_date(s.outdate))<=11 then '0-1年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=12
    and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '1-2年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=24
    and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '2-3年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=36
    and mon_diff(t.mon_label,tran_date(s.outdate))<=47 then '3-4年'
    when mon_diff(t.mon_label,tran_date(s.outdate))>=48
    and mon_diff(t.mon_label,tran_date(s.outdate))<=59 then '4-5年'
    else '5+年' end as age_type,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.age_type=t.age_type 
  and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification;

----kpi_3.62(濒临流失客户率_二级_保内外)
insert overwrite table  kpi_b_bnbw
select s.primary_classification,s.second_level_classification,s.bn,s.mon,
  sum(case when t.vin is null then 1 else 0 end)/count(s.vin) as num,
  s.asc_code
  from (
  select distinct s.asc_code,primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)=substr(add_months(t.mon_label,-6),1,7)
  and s.MAINT_TYPE1<>'删除'
  and s.order_balance_amount>0
  ) s left join 
  (
  select distinct s.asc_code,primary_classification,second_level_classification,
  case when s.outdate='未知' then '未知'
    when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=23 then '保内'
	when s.outdate<'2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>23 then '保外'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))<=35 then '保内'
	when s.outdate>='2013-10-01' 
	and mon_diff(t.mon_label,tran_date(s.outdate))>35 then '保外'
	else '' end as bn,
  substr(t.mon_label,1,7) as mon,
  s.vin
  from date_label t,label_order s 
where substr(t.mon_label,1,7)>='${begin_date}'
  and substr(t.mon_label,1,7)<='${end_date}'
  and substr(tran_date(s.order_balance_date),1,7)>=substr(add_months(t.mon_label,-5),1,7)
  and substr(tran_date(s.order_balance_date),1,7)<=substr(t.mon_label,1,7)
  and s.MAINT_TYPE1<>'删除'
  ) t on s.asc_code=t.asc_code and s.mon=t.mon and s.bn=t.bn
  and s.primary_classification=t.primary_classification
  and s.second_level_classification=t.second_level_classification;






  

  

  



  





